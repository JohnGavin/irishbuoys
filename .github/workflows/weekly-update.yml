name: Weekly Data Update

on:
  schedule:
    - cron: '0 2 * * 0'  # Sundays 2 AM UTC
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: Setup Cachix (rstats-on-nix)
        uses: cachix/cachix-action@v15
        with:
          name: rstats-on-nix
          extraPullNames: johngavin

      - name: Perform incremental data update
        run: |
          export NIX_PATH=nixpkgs=https://github.com/rstats-on-nix/nixpkgs/archive/2026-01-26.tar.gz
          nix-shell default.nix -A shell --run "Rscript -e '
            devtools::load_all()
            result <- incremental_update(db_path = \"inst/extdata/irish_buoys.duckdb\", lookback_hours = 72)
            saveRDS(result, file = paste0(\"update_log_\", Sys.Date(), \".rds\"))
            if (result\$status == \"error\") quit(status = 1)
            cat(\"Records added:\", result\$records_added, \"\\n\")
          '"

      - name: Run targets pipeline for wave analysis
        run: |
          export NIX_PATH=nixpkgs=https://github.com/rstats-on-nix/nixpkgs/archive/2026-01-26.tar.gz
          nix-shell default.nix -A shell --run "Rscript -e '
            targets::tar_make()
          '" || echo "Targets pipeline completed with warnings"

      - name: Render wave analysis vignette
        run: |
          export NIX_PATH=nixpkgs=https://github.com/rstats-on-nix/nixpkgs/archive/2026-01-26.tar.gz
          nix-shell default.nix -A shell --run "
            cd vignettes && quarto render wave_analysis.qmd
          "
          cp docs/vignettes/wave_analysis.html docs/articles/ || true
          cp -r docs/vignettes/wave_analysis_files docs/articles/ 2>/dev/null || true

      - name: Commit updates
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add inst/extdata/ docs/articles/ docs/vignettes/ _targets/ || true
          git diff --staged --quiet || git commit -m "ðŸ”„ Weekly update: data + wave analysis - $(date +'%Y-%m-%d')"
          git push || true

      - name: Upload update log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-log
          path: update_log_*.rds
          retention-days: 30
          if-no-files-found: ignore
