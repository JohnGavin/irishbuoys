name: Weekly Data Update

on:
  schedule:
    - cron: '0 2 * * 0'  # Sundays 2 AM UTC
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: Setup Cachix (rstats-on-nix)
        uses: cachix/cachix-action@v15
        with:
          name: rstats-on-nix
          extraPullNames: johngavin

      - name: Perform incremental update
        run: |
          nix-shell default.nix -A shell --run "Rscript -e '
            devtools::load_all()
            result <- incremental_update(db_path = \"inst/extdata/irish_buoys.duckdb\", lookback_hours = 72)
            saveRDS(result, file = paste0(\"update_log_\", Sys.Date(), \".rds\"))
            if (result\$status == \"error\") quit(status = 1)
            cat(\"Records added:\", result\$records_added, \"\\n\")
          '"

      - name: Commit updated database
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add inst/extdata/irish_buoys.duckdb || true
          git diff --staged --quiet || git commit -m "ðŸ”„ Weekly data update - $(date +'%Y-%m-%d')"
          git push || true

      - name: Upload update log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-log
          path: update_log_*.rds
          retention-days: 30
          if-no-files-found: ignore
