name: Weekly Data Update

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: 'release'
        use-public-rspm: true

    - name: Install dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        extra-packages: any::remotes
        needs: check

    - name: Perform incremental update
      run: |
        library(irishbuoys)

        # Perform the update
        result <- incremental_update(
          db_path = "inst/extdata/irish_buoys.duckdb",
          lookback_hours = 72  # Look back 3 days for safety
        )

        # Save update log
        saveRDS(result, file = paste0("update_log_", Sys.Date(), ".rds"))

        # Print summary
        if (result$status == "success") {
          cat("‚úÖ Update successful\n")
          cat("Records added:", result$records_added, "\n")
          if (result$records_added > 0) {
            print(result$summary)
          }
        } else if (result$status == "error") {
          cat("‚ùå Update failed\n")
          cat("Error:", result$error, "\n")
          quit(status = 1)
        } else {
          cat("‚ÑπÔ∏è Database is up to date\n")
        }

        # Get and print database statistics
        stats <- get_database_stats()
        cat("\nüìä Database Statistics:\n")
        cat("Total records:", format(stats$overall$total_records, big.mark = ","), "\n")
        cat("Date range:", stats$overall$earliest_date, "to", stats$overall$latest_date, "\n")
        cat("Database size:", round(stats$db_size_mb, 2), "MB\n")
      shell: Rscript {0}

    - name: Commit updated database
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add inst/extdata/irish_buoys.duckdb
        git diff --staged --quiet || git commit -m "üîÑ Weekly data update - $(date +'%Y-%m-%d')"
        git push

    - name: Upload update log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-log
        path: update_log_*.rds
        retention-days: 30

  send-summary:
    needs: update-data
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: 'release'
        use-public-rspm: true

    - name: Install dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        extra-packages: any::blastula
        needs: check

    - name: Generate and send email summary
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        EMAIL_SMTP_USER: ${{ secrets.EMAIL_SMTP_USER }}
        EMAIL_SMTP_PASS: ${{ secrets.EMAIL_SMTP_PASS }}
      run: |
        source("R/email_summary.R")
        generate_and_send_summary()
      shell: Rscript {0}