name: Weekly Data Update

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Build and enter Nix environment
      run: |
        # Build the environment (uses default.nix)
        nix-build default.nix -A shell --out-link nix-shell-ci

    - name: Perform incremental update
      run: |
        nix-shell --run "Rscript -e '
          devtools::load_all()

          # Perform the update
          result <- incremental_update(
            db_path = \"inst/extdata/irish_buoys.duckdb\",
            lookback_hours = 72
          )

          # Save update log
          saveRDS(result, file = paste0(\"update_log_\", Sys.Date(), \".rds\"))

          # Print summary
          if (result\$status == \"success\") {
            cat(\"âœ… Update successful\\n\")
            cat(\"Records added:\", result\$records_added, \"\\n\")
          } else if (result\$status == \"error\") {
            cat(\"âŒ Update failed\\n\")
            cat(\"Error:\", result\$error, \"\\n\")
            quit(status = 1)
          } else {
            cat(\"â„¹ï¸ Database is up to date\\n\")
          }

          # Get stats
          stats <- get_database_stats()
          if (!is.null(stats)) {
            cat(\"Total records:\", format(stats\$overall\$total_records, big.mark = \",\"), \"\\n\")
          }
        '"

    - name: Commit updated database
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add inst/extdata/irish_buoys.duckdb || true
        git diff --staged --quiet || git commit -m "ðŸ”„ Weekly data update - $(date +'%Y-%m-%d')"
        git push || true

    - name: Upload update log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-log
        path: update_log_*.rds
        retention-days: 30
        if-no-files-found: ignore
