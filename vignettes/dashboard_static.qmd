---
title: "Irish Weather Buoy Explorer"
format:
  dashboard:
    orientation: rows
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(dplyr)
library(ggplot2)
library(DT)
library(dygraphs)
library(xts)
library(tidyr)

# Load pre-computed data from targets pipeline
# Run targets::tar_make() to generate these files
# Use relative path during vignette rendering (from vignettes/ directory)
data_dir <- "../inst/extdata"
if (!dir.exists(data_dir)) {
  # Fallback for installed package
  data_dir <- system.file("extdata", package = "irishbuoys")
}

buoy_data <- readRDS(file.path(data_dir, "dashboard_buoy_data.rds"))
dashboard_stats <- readRDS(file.path(data_dir, "dashboard_stats.rds"))
dashboard_ts <- readRDS(file.path(data_dir, "dashboard_timeseries.rds"))

# Get package version from DESCRIPTION (works during vignette rendering)
pkg_version <- tryCatch(
  as.character(packageVersion("irishbuoys")),
  error = function(e) {
    desc_file <- "../DESCRIPTION"
    if (file.exists(desc_file)) {
      desc <- read.dcf(desc_file)
      desc[1, "Version"]
    } else {
      "dev"
    }
  }
)

# Get unique stations
stations <- sort(unique(buoy_data$station_id))

# Variable definitions
VAR_CHOICES <- c(
  "Wave Height (m)" = "wave_height",
  "Max Wave Height (m)" = "hmax",
  "Wave Period (s)" = "wave_period",
  "Wind Speed (knots)" = "wind_speed",
  "Wind Gust (knots)" = "gust",
  "Air Temperature (C)" = "air_temperature",
  "Sea Temperature (C)" = "sea_temperature",
  "Pressure (hPa)" = "atmospheric_pressure"
)

# Helper function to create station-specific data
get_station_data <- function(data, station, days = NULL) {
  if (!is.null(days)) {
    cutoff <- max(data$time) - (days * 24 * 3600)
    data <- data |> filter(time >= cutoff)
  }
  if (station != "All Buoys") {
    data <- data |> filter(station_id == station)
  }
  data
}

# Helper function to create dygraph time series
create_dygraph <- function(data, variable = "wave_height", title = "", by_station = TRUE) {
  var_label <- names(VAR_CHOICES)[VAR_CHOICES == variable]
  if (length(var_label) == 0) var_label <- variable

  if (by_station && length(unique(data$station_id)) > 1) {
    # Create wide format for multiple stations
    wide_data <- data |>
      select(time, station_id, all_of(variable)) |>
      tidyr::pivot_wider(names_from = station_id, values_from = all_of(variable))

    # Convert to xts
    ts_data <- xts(wide_data[, -1], order.by = wide_data$time)
  } else {
    # Single station or already filtered
    ts_data <- xts(data[[variable]], order.by = data$time)
    colnames(ts_data) <- var_label
  }

  dygraph(ts_data, main = title) |>
    dyOptions(
      labelsUTC = TRUE,
      fillGraph = TRUE,
      fillAlpha = 0.1,
      drawGrid = TRUE,
      colors = RColorBrewer::brewer.pal(max(3, ncol(ts_data)), "Set1")[1:ncol(ts_data)]
    ) |>
    dyRangeSelector(height = 40) |>
    dyCrosshair(direction = "vertical") |>
    dyHighlight(
      highlightCircleSize = 5,
      highlightSeriesBackgroundAlpha = 0.2,
      hideOnMouseOut = FALSE
    ) |>
    dyLegend(show = "always", width = 400)
}

# Helper function for DT tables with optimized timestamp display
create_dt <- function(data, caption = "") {
  # Find timestamp columns
  time_cols <- which(names(data) %in% c("time", "Time", "timestamp", "Timestamp", "datetime"))

  dt <- datatable(
    data,
    caption = caption,
    filter = 'top',
    extensions = 'Buttons',
    options = list(
      pageLength = 15,
      dom = 'Bfrtip',
      buttons = c('copy', 'csv', 'excel'),
      order = list(list(0, 'desc')),
      scrollX = TRUE,
      columnDefs = if (length(time_cols) > 0) {
        list(list(width = '150px', targets = time_cols - 1))
      } else NULL
    ),
    class = 'cell-border stripe hover compact'
  )

  # Style timestamp columns with smaller, non-wrapping text
  if (length(time_cols) > 0) {
    dt <- dt %>%
      DT::formatStyle(
        columns = names(data)[time_cols],
        fontSize = '11px',
        whiteSpace = 'nowrap'
      )
  }

  dt
}

# Calculate summary stats
valid_ww <- complete.cases(buoy_data$wind_speed, buoy_data$wave_height)
valid_wh <- complete.cases(buoy_data$wave_height, buoy_data$hmax)
cor_wind_wave <- round(cor(buoy_data$wind_speed[valid_ww], buoy_data$wave_height[valid_ww]), 3)
cor_wave_hmax <- round(cor(buoy_data$wave_height[valid_wh], buoy_data$hmax[valid_wh]), 3)
days_span <- as.numeric(difftime(max(buoy_data$time), min(buoy_data$time), units = "days"))
```

# Overview

## Row {height=30%}

### Column

```{r}
#| content: valuebox
#| title: "Total Records"
list(
  icon = "database",
  color = "primary",
  value = format(nrow(buoy_data), big.mark = ",")
)
```

### Column

```{r}
#| content: valuebox
#| title: "Time Span"
list(
  icon = "calendar",
  color = "info",
  value = paste(round(days_span, 0), "days")
)
```

### Column

```{r}
#| content: valuebox
#| title: "Active Stations"
list(
  icon = "geo-alt",
  color = "success",
  value = length(stations)
)
```

### Column

```{r}
#| content: valuebox
#| title: "Wind-Wave Correlation"
list(
  icon = "graph-up",
  color = "warning",
  value = cor_wind_wave
)
```

## Row

### Column {width=60%}

#### All Stations Time Series

```{r}
#| title: "Wave Height - All Stations (Full History)"
create_dygraph(buoy_data, "wave_height", "Significant Wave Height (m)")
```

### Column {width=40%}

#### Data Summary

| Metric | Value |
|--------|-------|
| Records | `r format(nrow(buoy_data), big.mark = ",")` |
| Date Range | `r format(min(buoy_data$time), "%Y-%m-%d")` to `r format(max(buoy_data$time), "%Y-%m-%d")` |
| Stations | `r paste(stations, collapse = ", ")` |
| Wind-Wave Corr | `r cor_wind_wave` |
| Wave-Hmax Corr | `r cor_wave_hmax` |

**Data Sources:**

- [Marine Institute Ireland](https://www.marine.ie/)
- [ERDDAP Data Portal](https://erddap.marine.ie/)

# Wave Height {orientation="columns"}

## Column {width=65%}

### Row {.tabset}

#### All Stations

```{r}
create_dygraph(buoy_data, "wave_height", "Wave Height - All Stations")
```

#### M2

```{r}
stn_data <- get_station_data(buoy_data, "M2")
create_dygraph(stn_data, "wave_height", "Wave Height - M2", by_station = FALSE)
```

#### M3

```{r}
stn_data <- get_station_data(buoy_data, "M3")
create_dygraph(stn_data, "wave_height", "Wave Height - M3", by_station = FALSE)
```

#### M4

```{r}
stn_data <- get_station_data(buoy_data, "M4")
create_dygraph(stn_data, "wave_height", "Wave Height - M4", by_station = FALSE)
```

#### M5

```{r}
stn_data <- get_station_data(buoy_data, "M5")
create_dygraph(stn_data, "wave_height", "Wave Height - M5", by_station = FALSE)
```

#### M6

```{r}
stn_data <- get_station_data(buoy_data, "M6")
create_dygraph(stn_data, "wave_height", "Wave Height - M6", by_station = FALSE)
```

## Column {width=35%}

### Row {.tabset}

#### Data Table

```{r}
wave_data <- buoy_data |>
  select(time, station_id, wave_height, hmax, wave_period) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2),
    wave_period = round(wave_period, 1)
  ) |>
  arrange(desc(time))

create_dt(wave_data, "Wave Height Data - Click columns to sort/filter")
```

#### Statistics

```{r}
wave_stats <- buoy_data |>
  group_by(station_id) |>
  summarise(
    n = n(),
    mean_hs = round(mean(wave_height, na.rm = TRUE), 2),
    max_hs = round(max(wave_height, na.rm = TRUE), 2),
    max_hmax = round(max(hmax, na.rm = TRUE), 2),
    .groups = "drop"
  )

create_dt(wave_stats, "Wave Statistics by Station")
```

# Wind Speed {orientation="columns"}

## Column {width=65%}

### Row {.tabset}

#### All Stations

```{r}
create_dygraph(buoy_data, "wind_speed", "Wind Speed - All Stations")
```

#### M2

```{r}
stn_data <- get_station_data(buoy_data, "M2")
create_dygraph(stn_data, "wind_speed", "Wind Speed - M2", by_station = FALSE)
```

#### M3

```{r}
stn_data <- get_station_data(buoy_data, "M3")
create_dygraph(stn_data, "wind_speed", "Wind Speed - M3", by_station = FALSE)
```

#### M4

```{r}
stn_data <- get_station_data(buoy_data, "M4")
create_dygraph(stn_data, "wind_speed", "Wind Speed - M4", by_station = FALSE)
```

#### M5

```{r}
stn_data <- get_station_data(buoy_data, "M5")
create_dygraph(stn_data, "wind_speed", "Wind Speed - M5", by_station = FALSE)
```

#### M6

```{r}
stn_data <- get_station_data(buoy_data, "M6")
create_dygraph(stn_data, "wind_speed", "Wind Speed - M6", by_station = FALSE)
```

## Column {width=35%}

### Row {.tabset}

#### Data Table

```{r}
wind_data <- buoy_data |>
  select(time, station_id, wind_speed, gust, atmospheric_pressure) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wind_speed = round(wind_speed, 1),
    gust = round(gust, 1),
    atmospheric_pressure = round(atmospheric_pressure, 1)
  ) |>
  arrange(desc(time))

create_dt(wind_data, "Wind Data - Click columns to sort/filter")
```

#### Statistics

```{r}
wind_stats <- buoy_data |>
  group_by(station_id) |>
  summarise(
    n = n(),
    mean_wind = round(mean(wind_speed, na.rm = TRUE), 1),
    max_wind = round(max(wind_speed, na.rm = TRUE), 1),
    max_gust = round(max(gust, na.rm = TRUE), 1),
    .groups = "drop"
  )

create_dt(wind_stats, "Wind Statistics by Station")
```

# Wind vs Wave {orientation="columns"}

## Column {width=65%}

### Row {.tabset}

#### All Stations

```{r}
#| fig-height: 6
ggplot(buoy_data, aes(x = wind_speed, y = wave_height, color = station_id)) +
  geom_point(alpha = 0.3, size = 1) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.8) +
  labs(
    title = "Wind Speed vs Wave Height - All Stations",
    x = "Wind Speed (knots)",
    y = "Significant Wave Height (m)",
    color = "Station"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#### M2

```{r}
stn_data <- get_station_data(buoy_data, "M2")
ggplot(stn_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Wind vs Wave - M2", x = "Wind Speed (knots)", y = "Wave Height (m)") +
  theme_minimal()
```

#### M3

```{r}
stn_data <- get_station_data(buoy_data, "M3")
ggplot(stn_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Wind vs Wave - M3", x = "Wind Speed (knots)", y = "Wave Height (m)") +
  theme_minimal()
```

#### M4

```{r}
stn_data <- get_station_data(buoy_data, "M4")
ggplot(stn_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Wind vs Wave - M4", x = "Wind Speed (knots)", y = "Wave Height (m)") +
  theme_minimal()
```

#### M5

```{r}
stn_data <- get_station_data(buoy_data, "M5")
ggplot(stn_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Wind vs Wave - M5", x = "Wind Speed (knots)", y = "Wave Height (m)") +
  theme_minimal()
```

#### M6

```{r}
stn_data <- get_station_data(buoy_data, "M6")
ggplot(stn_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Wind vs Wave - M6", x = "Wind Speed (knots)", y = "Wave Height (m)") +
  theme_minimal()
```

## Column {width=35%}

### Row {.tabset}

#### Correlation Data

```{r}
scatter_data <- buoy_data |>
  select(time, station_id, wind_speed, wave_height, hmax) |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wind_speed = round(wind_speed, 1),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2)
  ) |>
  arrange(desc(time))

create_dt(scatter_data, "Wind-Wave Data")
```

#### Regression Stats

```{r}
reg_stats <- buoy_data |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  group_by(station_id) |>
  summarise(
    n = n(),
    correlation = round(cor(wind_speed, wave_height), 3),
    intercept = round(coef(lm(wave_height ~ wind_speed))[1], 3),
    slope = round(coef(lm(wave_height ~ wind_speed))[2], 4),
    .groups = "drop"
  )

create_dt(reg_stats, "Linear Regression by Station")
```

# Recent Data

## Row

### Column

```{r}
recent_data <- buoy_data |>
  arrange(desc(time)) |>
  head(500) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2),
    wind_speed = round(wind_speed, 1),
    gust = round(gust, 1),
    air_temperature = round(air_temperature, 1),
    sea_temperature = round(sea_temperature, 1),
    atmospheric_pressure = round(atmospheric_pressure, 1)
  ) |>
  select(time, station_id, wave_height, hmax, wind_speed, gust,
         air_temperature, sea_temperature, atmospheric_pressure)

datatable(
  recent_data,
  caption = "Most recent 500 observations - click column headers to sort, use filters above each column",
  filter = 'top',
  extensions = 'Buttons',
  colnames = c("Time (UTC)", "Station", "Wave Ht (m)", "Hmax (m)", "Wind (kn)",
               "Gust (kn)", "Air Temp (C)", "Sea Temp (C)", "Pressure (hPa)"),
  options = list(
    pageLength = 25,
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel'),
    order = list(list(0, 'desc')),
    scrollX = TRUE
  ),
  class = 'cell-border stripe hover compact'
)
```

# Reference

## Row

### Column {width=50%}

#### Variable Definitions

| Variable | Units | Description |
|----------|-------|-------------|
| wave_height | meters | Significant wave height (Hs). 4× RMS of wave motion over 17.5 min |
| hmax | meters | Maximum individual wave height in measurement period |
| wave_period | seconds | Average wave period (zero-crossing analysis) |
| wind_speed | knots | 10-minute average wind speed. 1 knot = 0.514 m/s |
| gust | knots | Maximum 3-second wind speed during the hour |
| atmospheric_pressure | hPa | Barometric pressure (970-1030 typical) |
| air_temperature | °C | Air temperature at buoy (~3m above sea) |
| sea_temperature | °C | Sea surface temperature |

### Column {width=50%}

#### Station Information

| Station | Location | Notes |
|---------|----------|-------|
| M2 | Southwest Ireland | Deep water buoy |
| M3 | Southwest Ireland | Deep water buoy |
| M4 | Southeast Ireland | Deep water buoy |
| M5 | West Ireland | Deep water buoy |
| M6 | Northwest Ireland | Shelf edge location |

**Data Sources:**

- [Marine Institute Ireland](https://www.marine.ie/)
- [ERDDAP Data Portal](https://erddap.marine.ie/)
- [irishbuoys R Package](https://github.com/JohnGavin/irishbuoys)

---

*Dashboard generated `r Sys.time()` UTC using irishbuoys v`r pkg_version`*
