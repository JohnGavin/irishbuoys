---
title: "Irish Weather Buoy Explorer"
format:
  dashboard:
    orientation: rows
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(dygraphs)
library(xts)
library(tidyr)

# Load pre-computed data from targets pipeline
data_dir <- "../inst/extdata"
if (!dir.exists(data_dir)) {
  data_dir <- system.file("extdata", package = "irishbuoys")
}

buoy_data <- readRDS(file.path(data_dir, "dashboard_buoy_data.rds"))
dashboard_stats <- readRDS(file.path(data_dir, "dashboard_stats.rds"))
dashboard_ts <- readRDS(file.path(data_dir, "dashboard_timeseries.rds"))

# Get package version
pkg_version <- tryCatch(
  as.character(packageVersion("irishbuoys")),
  error = function(e) {
    desc_file <- "../DESCRIPTION"
    if (file.exists(desc_file)) {
      desc <- read.dcf(desc_file)
      desc[1, "Version"]
    } else "dev"
  }
)

# Get unique stations
stations <- sort(unique(buoy_data$station_id))

# Calculate summary stats
valid_ww <- complete.cases(buoy_data$wind_speed, buoy_data$wave_height)
valid_wh <- complete.cases(buoy_data$wave_height, buoy_data$hmax)
cor_wind_wave <- round(cor(buoy_data$wind_speed[valid_ww], buoy_data$wave_height[valid_ww]), 3)
cor_wave_hmax <- round(cor(buoy_data$wave_height[valid_wh], buoy_data$hmax[valid_wh]), 3)
days_span <- round(as.numeric(difftime(max(buoy_data$time), min(buoy_data$time), units = "days")))
generated_time <- format(Sys.time(), "%Y-%m-%d %H:%M UTC")

# Helper function to create station-specific data
get_station_data <- function(data, station) {
  if (station != "All Buoys") {
    data <- data |> filter(station_id == station)
  }
  data
}

# Helper function to create dygraph time series - full width
create_dygraph <- function(data, variable = "wave_height", title = "", by_station = TRUE) {
  if (by_station && length(unique(data$station_id)) > 1) {
    wide_data <- data |>
      select(time, station_id, all_of(variable)) |>
      tidyr::pivot_wider(names_from = station_id, values_from = all_of(variable))
    ts_data <- xts(wide_data[, -1], order.by = wide_data$time)
  } else {
    ts_data <- xts(data[[variable]], order.by = data$time)
    colnames(ts_data) <- variable
  }

  dygraph(ts_data, main = title, width = "100%") |>
    dyOptions(
      labelsUTC = TRUE,
      fillGraph = TRUE,
      fillAlpha = 0.1,
      drawGrid = TRUE,
      colors = RColorBrewer::brewer.pal(max(3, ncol(ts_data)), "Set1")[1:ncol(ts_data)]
    ) |>
    dyRangeSelector(height = 40) |>
    dyCrosshair(direction = "vertical") |>
    dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE) |>
    dyLegend(show = "always", width = 400)
}

# Helper function for DT tables with optimized timestamp display
create_dt <- function(data, caption = "", time_width = "140px") {
  time_cols <- which(names(data) %in% c("time", "Time", "timestamp", "Timestamp", "datetime", "Time (UTC)"))

  dt <- datatable(
    data,
    caption = caption,
    filter = 'top',
    extensions = 'Buttons',
    options = list(
      pageLength = 15,
      dom = 'Bfrtip',
      buttons = c('copy', 'csv', 'excel'),
      order = list(list(0, 'desc')),
      scrollX = TRUE,
      columnDefs = if (length(time_cols) > 0) {
        list(list(width = time_width, targets = time_cols - 1))
      } else NULL
    ),
    class = 'cell-border stripe hover compact'
  )

  if (length(time_cols) > 0) {
    dt <- dt %>%
      DT::formatStyle(columns = time_cols, fontSize = '10px', whiteSpace = 'nowrap')
  }

  dt
}

# Station information with coordinates and depths
station_info <- data.frame(
  Station = c("M2", "M3", "M4", "M5", "M6"),
  Location = c("Southwest Ireland", "Southwest Ireland", "Southeast Ireland", "West Ireland", "Northwest Ireland"),
  Latitude = c(51.22, 51.22, 51.69, 51.69, 53.07),
  Longitude = c(-9.99, -10.55, -6.70, -10.00, -15.93),
  `Water Depth (m)` = c(155, 155, 62, 70, 3000),
  `Distance from Shore (km)` = c(50, 65, 30, 55, 320),
  check.names = FALSE
)
```

# Overview

## Row

### Column {width=100%}

```{r}
#| title: "Wave Height Time Series - All Stations (Full Dataset)"
create_dygraph(buoy_data, "wave_height", "Significant Wave Height (Hs) in meters")
```

## Row {height=25%}

### Column

**Dataset Summary:** `r format(nrow(buoy_data), big.mark=",")` records from `r length(stations)` stations (`r paste(stations, collapse=", ")`) spanning `r days_span` days (`r format(min(buoy_data$time), "%Y-%m-%d")` to `r format(max(buoy_data$time), "%Y-%m-%d")`). Wind-wave correlation: `r cor_wind_wave`, Wave-Hmax correlation: `r cor_wave_hmax`.

| Metric | Value | Metric | Value |
|--------|-------|--------|-------|
| Total Records | `r format(nrow(buoy_data), big.mark=",")` | Wind-Wave Correlation | `r cor_wind_wave` |
| Active Stations | `r length(stations)` | Wave-Hmax Correlation | `r cor_wave_hmax` |
| Date Range | `r format(min(buoy_data$time), "%Y-%m-%d")` - `r format(max(buoy_data$time), "%Y-%m-%d")` | Max Wave Height | `r round(max(buoy_data$hmax, na.rm=TRUE), 1)` m |
| Time Span | `r days_span` days | Max Wind Gust | `r round(max(buoy_data$gust, na.rm=TRUE), 1)` knots |

*Dashboard generated `r generated_time` using irishbuoys v`r pkg_version`*

# Wave Height

## Row

### Column {.tabset}

#### All Stations

```{r}
create_dygraph(buoy_data, "wave_height", "Wave Height - All Stations")
```

#### M2

```{r}
create_dygraph(get_station_data(buoy_data, "M2"), "wave_height", "Wave Height - M2", by_station = FALSE)
```

#### M3

```{r}
create_dygraph(get_station_data(buoy_data, "M3"), "wave_height", "Wave Height - M3", by_station = FALSE)
```

#### M4

```{r}
create_dygraph(get_station_data(buoy_data, "M4"), "wave_height", "Wave Height - M4", by_station = FALSE)
```

#### M5

```{r}
create_dygraph(get_station_data(buoy_data, "M5"), "wave_height", "Wave Height - M5", by_station = FALSE)
```

#### M6

```{r}
create_dygraph(get_station_data(buoy_data, "M6"), "wave_height", "Wave Height - M6", by_station = FALSE)
```

## Row {height=35%}

### Column {.tabset}

#### Statistics

```{r}
wave_stats <- buoy_data |>
  group_by(station_id) |>
  summarise(
    Records = n(),
    `Mean Hs (m)` = round(mean(wave_height, na.rm = TRUE), 2),
    `Max Hs (m)` = round(max(wave_height, na.rm = TRUE), 2),
    `Max Hmax (m)` = round(max(hmax, na.rm = TRUE), 2),
    .groups = "drop"
  )
create_dt(wave_stats, "Wave Statistics by Station")
```

#### Data Table

```{r}
wave_data <- buoy_data |>
  select(time, station_id, wave_height, hmax, wave_period) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2),
    wave_period = round(wave_period, 1)
  ) |>
  arrange(desc(time))
create_dt(wave_data, "Wave Height Data")
```

# Wind Speed

## Row

### Column {.tabset}

#### All Stations

```{r}
create_dygraph(buoy_data, "wind_speed", "Wind Speed - All Stations")
```

#### M2

```{r}
create_dygraph(get_station_data(buoy_data, "M2"), "wind_speed", "Wind Speed - M2", by_station = FALSE)
```

#### M3

```{r}
create_dygraph(get_station_data(buoy_data, "M3"), "wind_speed", "Wind Speed - M3", by_station = FALSE)
```

#### M4

```{r}
create_dygraph(get_station_data(buoy_data, "M4"), "wind_speed", "Wind Speed - M4", by_station = FALSE)
```

#### M5

```{r}
create_dygraph(get_station_data(buoy_data, "M5"), "wind_speed", "Wind Speed - M5", by_station = FALSE)
```

#### M6

```{r}
create_dygraph(get_station_data(buoy_data, "M6"), "wind_speed", "Wind Speed - M6", by_station = FALSE)
```

## Row {height=35%}

### Column {.tabset}

#### Statistics

```{r}
wind_stats <- buoy_data |>
  group_by(station_id) |>
  summarise(
    Records = n(),
    `Mean Wind (kn)` = round(mean(wind_speed, na.rm = TRUE), 1),
    `Max Wind (kn)` = round(max(wind_speed, na.rm = TRUE), 1),
    `Max Gust (kn)` = round(max(gust, na.rm = TRUE), 1),
    .groups = "drop"
  )
create_dt(wind_stats, "Wind Statistics by Station")
```

#### Data Table

```{r}
wind_data <- buoy_data |>
  select(time, station_id, wind_speed, gust, atmospheric_pressure) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wind_speed = round(wind_speed, 1),
    gust = round(gust, 1),
    atmospheric_pressure = round(atmospheric_pressure, 1)
  ) |>
  arrange(desc(time))
create_dt(wind_data, "Wind Data")
```

# Wind vs Wave

## Row

### Column {width=100%}

```{r}
# Compute regression slopes to order panels
reg_stats <- buoy_data |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  group_by(Station = station_id) |>
  summarise(
    Records = n(),
    Correlation = round(cor(wind_speed, wave_height), 3),
    Intercept = round(coef(lm(wave_height ~ wind_speed))[1], 3),
    Slope = round(coef(lm(wave_height ~ wind_speed))[2], 4),
    .groups = "drop"
  ) |>
  arrange(desc(Slope))

# Order stations by slope (largest first)
station_order <- reg_stats$Station
panel_labels <- paste0(station_order, " (slope=", reg_stats$Slope, ")")

plot_data <- buoy_data |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  mutate(
    station_label = factor(
      paste0(station_id, " (slope=", reg_stats$Slope[match(station_id, reg_stats$Station)], ")"),
      levels = panel_labels
    )
  )

p <- ggplot(plot_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.3, size = 1, aes(
    text = paste0("Station: ", station_id, "<br>",
                  "Wind: ", round(wind_speed, 1), " m/s<br>",
                  "Wave Ht: ", round(wave_height, 2), " m<br>",
                  "Time: ", format(time, "%Y-%m-%d %H:%M"))
  )) +
  geom_smooth(method = "lm", se = TRUE, color = "red", alpha = 0.2) +
  facet_wrap(~station_label, nrow = 1) +
  labs(x = "Wind Speed (m/s)", y = "Wave Height (m)") +
  theme_minimal(base_size = 11) +
  theme(strip.text = element_text(face = "bold"))

ggplotly(p, tooltip = "text") |>
  layout(title = "Wind Speed vs Wave Height (panels ordered by regression slope)")
```

## Row {height=30%}

### Column {.tabset}

#### Regression Stats

```{r}
create_dt(reg_stats, "Linear Regression by Station (ordered by slope)")
```

#### Data

```{r}
scatter_data <- buoy_data |>
  select(time, station_id, wind_speed, wave_height, hmax) |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wind_speed = round(wind_speed, 1),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2)
  ) |>
  arrange(desc(time))
create_dt(scatter_data, "Wind-Wave Data")
```

# Recent Data

## Row

### Column

```{r}
recent_data <- buoy_data |>
  arrange(desc(time)) |>
  head(500) |>
  mutate(
    `Time (UTC)` = format(time, "%m-%d %H:%M"),
    Station = station_id,
    `Hs (m)` = round(wave_height, 2),
    `Hmax (m)` = round(hmax, 2),
    `Wind (kn)` = round(wind_speed, 1),
    `Gust (kn)` = round(gust, 1),
    `Air (C)` = round(air_temperature, 1),
    `Sea (C)` = round(sea_temperature, 1),
    `hPa` = round(atmospheric_pressure, 1)
  ) |>
  select(`Time (UTC)`, Station, `Hs (m)`, `Hmax (m)`, `Wind (kn)`, `Gust (kn)`, `Air (C)`, `Sea (C)`, `hPa`)

datatable(
  recent_data,
  caption = "Most recent 500 observations",
  filter = 'top',
  extensions = 'Buttons',
  options = list(
    pageLength = 25,
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel'),
    order = list(list(0, 'desc')),
    scrollX = TRUE,
    columnDefs = list(list(width = '80px', targets = 0))
  ),
  class = 'cell-border stripe hover compact'
) %>%
  DT::formatStyle(columns = 1, fontSize = '10px', whiteSpace = 'nowrap')
```

# Reference

## Row

### Column {width=50%}

#### Variable Definitions

| Variable | Units | Description |
|----------|-------|-------------|
| wave_height (Hs) | m | [Significant wave height](https://en.wikipedia.org/wiki/Significant_wave_height): 4× [RMS](https://en.wikipedia.org/wiki/Root_mean_square) of wave motion over [17.5-min period](https://www.ocean-sci.net/15/789/2019/) |
| hmax | m | Maximum individual wave height in measurement period |
| wave_period | s | Average wave period ([zero-crossing analysis](https://en.wikipedia.org/wiki/Wave_period)) |
| wind_speed | kn | 10-minute average wind speed ([1 kn = 0.514 m/s](https://en.wikipedia.org/wiki/Knot_(unit))) |
| gust | kn | Maximum [3-second wind gust](https://glossary.ametsoc.org/wiki/Gust) during the hour |
| atmospheric_pressure | hPa | [Barometric pressure](https://en.wikipedia.org/wiki/Atmospheric_pressure) (970-1030 typical) |
| air_temperature | °C | Air temperature at buoy (~3m above sea) |
| sea_temperature | °C | [Sea surface temperature](https://en.wikipedia.org/wiki/Sea_surface_temperature) (SST) |

### Column {width=50%}

#### Station Information

```{r}
create_dt(station_info, "Irish Weather Buoy Network Stations")
```

**Data Sources:**

- [Marine Institute Ireland](https://www.marine.ie/)
- [ERDDAP Data Portal](https://erddap.marine.ie/erddap/tabledap/IWBNetwork.html)
- [irishbuoys R Package](https://github.com/JohnGavin/irishbuoys)

---

*Dashboard generated `r generated_time` using irishbuoys v`r pkg_version`*
