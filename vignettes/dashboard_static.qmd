---
title: "Irish Weather Buoy Explorer"
format:
  dashboard:
    orientation: rows
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(dygraphs)
library(xts)
library(tidyr)

# Load pre-computed data from targets pipeline
data_dir <- "../inst/extdata"
if (!dir.exists(data_dir)) {
  data_dir <- system.file("extdata", package = "irishbuoys")
}

buoy_data <- readRDS(file.path(data_dir, "dashboard_buoy_data.rds"))
dashboard_stats <- readRDS(file.path(data_dir, "dashboard_stats.rds"))
dashboard_ts <- readRDS(file.path(data_dir, "dashboard_timeseries.rds"))

# Get package version
pkg_version <- tryCatch(
  as.character(packageVersion("irishbuoys")),
  error = function(e) {
    desc_file <- "../DESCRIPTION"
    if (file.exists(desc_file)) {
      desc <- read.dcf(desc_file)
      desc[1, "Version"]
    } else "dev"
  }
)

# Get unique stations
stations <- sort(unique(buoy_data$station_id))

# Create daily averages for time series (reduces HTML size)
buoy_daily <- buoy_data |>
  mutate(date = as.Date(time)) |>
  group_by(station_id, date) |>
  summarise(
    time = as.POSIXct(paste0(unique(date), " 12:00:00"), tz = "UTC"),
    wave_height = mean(wave_height, na.rm = TRUE),
    hmax = max(hmax, na.rm = TRUE),
    wave_period = mean(wave_period, na.rm = TRUE),
    wind_speed = mean(wind_speed, na.rm = TRUE),
    gust = max(gust, na.rm = TRUE),
    atmospheric_pressure = mean(atmospheric_pressure, na.rm = TRUE),
    air_temperature = mean(air_temperature, na.rm = TRUE),
    sea_temperature = mean(sea_temperature, na.rm = TRUE),
    .groups = "drop"
  ) |>
  select(-date)

# Calculate summary stats
valid_ww <- complete.cases(buoy_data$wind_speed, buoy_data$wave_height)
valid_wh <- complete.cases(buoy_data$wave_height, buoy_data$hmax)
cor_wind_wave <- round(cor(buoy_data$wind_speed[valid_ww], buoy_data$wave_height[valid_ww]), 3)
cor_wave_hmax <- round(cor(buoy_data$wave_height[valid_wh], buoy_data$hmax[valid_wh]), 3)
days_span <- round(as.numeric(difftime(max(buoy_data$time), min(buoy_data$time), units = "days")))
generated_time <- format(Sys.time(), "%Y-%m-%d %H:%M UTC")
date_caption <- paste0(format(min(buoy_data$time), "%Y-%m-%d"), " to ", format(max(buoy_data$time), "%Y-%m-%d"))

# Helper function to create station-specific data
get_station_data <- function(data, station) {
  if (station != "All Buoys") {
    data <- data |> filter(station_id == station)
  }
  data
}

# Helper function to create dygraph time series - full width
create_dygraph <- function(data, variable = "wave_height", title = "", by_station = TRUE) {
  if (by_station && length(unique(data$station_id)) > 1) {
    wide_data <- data |>
      select(time, station_id, all_of(variable)) |>
      tidyr::pivot_wider(names_from = station_id, values_from = all_of(variable))
    ts_data <- xts(wide_data[, -1], order.by = wide_data$time)
  } else {
    ts_data <- xts(data[[variable]], order.by = data$time)
    colnames(ts_data) <- variable
  }

  dygraph(ts_data, main = title, width = "100%") |>
    dyOptions(
      labelsUTC = TRUE,
      fillGraph = TRUE,
      fillAlpha = 0.1,
      drawGrid = TRUE,
      colors = RColorBrewer::brewer.pal(max(3, ncol(ts_data)), "Set1")[1:ncol(ts_data)]
    ) |>
    dyRangeSelector(height = 40) |>
    dyCrosshair(direction = "vertical") |>
    dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE) |>
    dyLegend(show = "always", width = 400)
}

# Helper function for DT tables with optimized timestamp display
create_dt <- function(data, caption = "", time_width = "140px") {
  time_cols <- which(names(data) %in% c("time", "Time", "timestamp", "Timestamp", "datetime", "Time (UTC)"))

  dt <- datatable(
    data,
    caption = caption,
    filter = 'top',
    extensions = 'Buttons',
    options = list(
      pageLength = 15,
      dom = 'Bfrtip',
      buttons = c('copy', 'csv', 'excel'),
      order = list(list(0, 'desc')),
      scrollX = TRUE,
      columnDefs = if (length(time_cols) > 0) {
        list(list(width = time_width, targets = time_cols - 1))
      } else NULL
    ),
    class = 'cell-border stripe hover compact'
  )

  if (length(time_cols) > 0) {
    dt <- dt %>%
      DT::formatStyle(columns = time_cols, fontSize = '10px', whiteSpace = 'nowrap')
  }

  dt
}

# Station information with coordinates and depths
station_info <- data.frame(
  Station = c("M2", "M3", "M4", "M5", "M6"),
  Location = c("Southwest Ireland", "Southwest Ireland", "Southeast Ireland", "West Ireland", "Northwest Ireland"),
  Latitude = c(51.22, 51.22, 51.69, 51.69, 53.07),
  Longitude = c(-9.99, -10.55, -6.70, -10.00, -15.93),
  `Water Depth (m)` = c(155, 155, 62, 70, 3000),
  `Distance from Shore (km)` = c(50, 65, 30, 55, 320),
  check.names = FALSE
)
```

# Overview

## Row

### Column {width=100%}

```{r}
#| title: "Wave Height Time Series - All Stations (Full Dataset)"
create_dygraph(buoy_daily, "wave_height", "Significant Wave Height (Hs) - Daily Means")
```

## Row {height=25%}

### Column

**Dataset Summary:** `r format(nrow(buoy_data), big.mark=",")` records from `r length(stations)` stations (`r paste(stations, collapse=", ")`) spanning `r days_span` days (`r format(min(buoy_data$time), "%Y-%m-%d")` to `r format(max(buoy_data$time), "%Y-%m-%d")`). Wind-wave correlation: `r cor_wind_wave`, Wave-Hmax correlation: `r cor_wave_hmax`.

| Metric | Value | Metric | Value |
|--------|-------|--------|-------|
| Total Records | `r format(nrow(buoy_data), big.mark=",")` | Wind-Wave Correlation | `r cor_wind_wave` |
| Active Stations | `r length(stations)` | Wave-Hmax Correlation | `r cor_wave_hmax` |
| Date Range | `r format(min(buoy_data$time), "%Y-%m-%d")` - `r format(max(buoy_data$time), "%Y-%m-%d")` | Max Wave Height | `r round(max(buoy_data$hmax, na.rm=TRUE), 1)` m |
| Time Span | `r days_span` days | Max Wind Gust | `r round(max(buoy_data$gust, na.rm=TRUE), 1)` knots |

*Dashboard generated `r generated_time` using irishbuoys v`r pkg_version`*

# Wave Height

## Row

### Column {.tabset}

#### All Stations

```{r}
create_dygraph(buoy_daily, "wave_height", "Wave Height - All Stations (Daily Means)")
```

#### M2

```{r}
create_dygraph(get_station_data(buoy_daily, "M2"), "wave_height", "Wave Height - M2 (Daily)", by_station = FALSE)
```

#### M3

```{r}
create_dygraph(get_station_data(buoy_daily, "M3"), "wave_height", "Wave Height - M3 (Daily)", by_station = FALSE)
```

#### M4

```{r}
create_dygraph(get_station_data(buoy_daily, "M4"), "wave_height", "Wave Height - M4 (Daily)", by_station = FALSE)
```

#### M5

```{r}
create_dygraph(get_station_data(buoy_daily, "M5"), "wave_height", "Wave Height - M5 (Daily)", by_station = FALSE)
```

#### M6

```{r}
create_dygraph(get_station_data(buoy_daily, "M6"), "wave_height", "Wave Height - M6 (Daily)", by_station = FALSE)
```

## Row {height=35%}

### Column {.tabset}

#### Statistics

```{r}
wave_stats <- buoy_data |>
  group_by(station_id) |>
  summarise(
    Records = n(),
    `Mean Hs (m)` = round(mean(wave_height, na.rm = TRUE), 2),
    `Max Hs (m)` = round(max(wave_height, na.rm = TRUE), 2),
    `Max Hmax (m)` = round(max(hmax, na.rm = TRUE), 2),
    .groups = "drop"
  )
create_dt(wave_stats, "Wave Statistics by Station")
```

#### Data Table

```{r}
wave_data <- buoy_data |>
  select(time, station_id, wave_height, hmax, wave_period) |>
  arrange(desc(time)) |>
  head(5000) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2),
    wave_period = round(wave_period, 1)
  )
create_dt(wave_data, paste0("Wave Height Data (most recent 5000 of ", format(nrow(buoy_data), big.mark=","), " records)"))
```

# Wind Speed

## Row

### Column {.tabset}

#### All Stations

```{r}
create_dygraph(buoy_daily, "wind_speed", "Wind Speed - All Stations (Daily Means)")
```

#### M2

```{r}
create_dygraph(get_station_data(buoy_daily, "M2"), "wind_speed", "Wind Speed - M2 (Daily)", by_station = FALSE)
```

#### M3

```{r}
create_dygraph(get_station_data(buoy_daily, "M3"), "wind_speed", "Wind Speed - M3 (Daily)", by_station = FALSE)
```

#### M4

```{r}
create_dygraph(get_station_data(buoy_daily, "M4"), "wind_speed", "Wind Speed - M4 (Daily)", by_station = FALSE)
```

#### M5

```{r}
create_dygraph(get_station_data(buoy_daily, "M5"), "wind_speed", "Wind Speed - M5 (Daily)", by_station = FALSE)
```

#### M6

```{r}
create_dygraph(get_station_data(buoy_daily, "M6"), "wind_speed", "Wind Speed - M6 (Daily)", by_station = FALSE)
```

## Row {height=35%}

### Column {.tabset}

#### Statistics

```{r}
wind_stats <- buoy_data |>
  group_by(station_id) |>
  summarise(
    Records = n(),
    `Mean Wind (kn)` = round(mean(wind_speed, na.rm = TRUE), 1),
    `Max Wind (kn)` = round(max(wind_speed, na.rm = TRUE), 1),
    `Max Gust (kn)` = round(max(gust, na.rm = TRUE), 1),
    .groups = "drop"
  )
create_dt(wind_stats, "Wind Statistics by Station")
```

#### Data Table

```{r}
wind_data <- buoy_data |>
  select(time, station_id, wind_speed, gust, atmospheric_pressure) |>
  arrange(desc(time)) |>
  head(5000) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wind_speed = round(wind_speed, 1),
    gust = round(gust, 1),
    atmospheric_pressure = round(atmospheric_pressure, 1)
  )
create_dt(wind_data, paste0("Wind Data (most recent 5000 of ", format(nrow(buoy_data), big.mark=","), " records)"))
```

# Wind vs Wave

## Row

### Column {width=100%}

```{r}
# Compute regression slopes to order panels
reg_stats <- buoy_data |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  group_by(Station = station_id) |>
  summarise(
    Records = n(),
    Correlation = round(cor(wind_speed, wave_height), 2),
    Intercept = round(coef(lm(wave_height ~ wind_speed))[1], 2),
    Slope = round(coef(lm(wave_height ~ wind_speed))[2], 2),
    .groups = "drop"
  ) |>
  arrange(desc(Slope))

# Order stations by slope (largest first)
station_order <- reg_stats$Station
panel_labels <- paste0(station_order, " (slope=", sprintf("%.2f", reg_stats$Slope), ")")

# Sample data for scatter plot to keep HTML size manageable
set.seed(42)
scatter_sample <- buoy_data |>
  filter(!is.na(wind_speed), !is.na(wave_height))
if (nrow(scatter_sample) > 15000) {
  scatter_sample <- scatter_sample |> slice_sample(n = 15000)
}
plot_data <- scatter_sample |>
  mutate(
    station_label = factor(
      paste0(station_id, " (slope=", sprintf("%.2f", reg_stats$Slope[match(station_id, reg_stats$Station)]), ")"),
      levels = panel_labels
    )
  )

p <- ggplot(plot_data, aes(x = wind_speed, y = wave_height)) +
  geom_point(alpha = 0.3, size = 1, aes(
    text = paste0("Station: ", station_id, "<br>",
                  "Wind: ", round(wind_speed, 1), " m/s<br>",
                  "Wave Ht: ", round(wave_height, 2), " m<br>",
                  "Time: ", format(time, "%Y-%m-%d %H:%M"))
  )) +
  geom_smooth(method = "lm", se = TRUE, color = "red", alpha = 0.2) +
  facet_wrap(~station_label, nrow = 1) +
  labs(x = "Wind Speed (m/s)", y = "Wave Height (m)") +
  theme_minimal(base_size = 11) +
  theme(strip.text = element_text(face = "bold"))

ggplotly(p, tooltip = "text") |>
  layout(title = paste0("Wind Speed vs Wave Height - ordered by slope (", date_caption, ")"))
```

## Row {height=30%}

### Column {.tabset}

#### Regression Stats

```{r}
create_dt(reg_stats, "Linear Regression by Station (ordered by slope)")
```

#### Data

```{r}
scatter_data <- buoy_data |>
  select(time, station_id, wind_speed, wave_height, hmax) |>
  filter(!is.na(wind_speed), !is.na(wave_height)) |>
  arrange(desc(time)) |>
  head(5000) |>
  mutate(
    time = format(time, "%Y-%m-%d %H:%M"),
    wind_speed = round(wind_speed, 1),
    wave_height = round(wave_height, 2),
    hmax = round(hmax, 2)
  )
create_dt(scatter_data, paste0("Wind-Wave Data (most recent 5000 of ", format(nrow(buoy_data), big.mark=","), " records)"))
```

# Recent Data

## Row

### Column

```{r}
recent_data <- buoy_data |>
  arrange(desc(time)) |>
  head(500) |>
  mutate(
    `Time (UTC)` = format(time, "%m-%d %H:%M"),
    Station = station_id,
    `Hs (m)` = round(wave_height, 2),
    `Hmax (m)` = round(hmax, 2),
    `Wind (kn)` = round(wind_speed, 1),
    `Gust (kn)` = round(gust, 1),
    `Air (C)` = round(air_temperature, 1),
    `Sea (C)` = round(sea_temperature, 1),
    `hPa` = round(atmospheric_pressure, 1)
  ) |>
  select(`Time (UTC)`, Station, `Hs (m)`, `Hmax (m)`, `Wind (kn)`, `Gust (kn)`, `Air (C)`, `Sea (C)`, `hPa`)

datatable(
  recent_data,
  caption = "Most recent 500 observations",
  filter = 'top',
  extensions = 'Buttons',
  options = list(
    pageLength = 25,
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel'),
    order = list(list(0, 'desc')),
    scrollX = TRUE,
    columnDefs = list(list(width = '80px', targets = 0))
  ),
  class = 'cell-border stripe hover compact'
) %>%
  DT::formatStyle(columns = 1, fontSize = '10px', whiteSpace = 'nowrap')
```

# Reference

## Row

### Column

#### Variable Definitions

| Variable | Units | Description |
|----------|-------|-------------|
| **wave_height (Hs)** | m | [Significant wave height](https://en.wikipedia.org/wiki/Significant_wave_height) (Hs): the average height of the highest one-third of waves, equivalent to 4x the [RMS](https://en.wikipedia.org/wiki/Root_mean_square) of sea surface elevation over a [17.5-min measurement period](https://www.ocean-sci.net/15/789/2019/). This is NOT the height of any single wave - it is a statistical measure that represents the "characteristic" wave height as perceived by an observer. Hs is lower than the maximum wave height (Hmax) because it averages over many waves. |
| hmax | m | Maximum individual wave height recorded in the measurement period. Typically Hmax/Hs ranges from 1.5 to 1.9; values above 2.0 indicate a [rogue wave](https://en.wikipedia.org/wiki/Rogue_wave). |
| wave_period | s | Average wave period via [zero-crossing analysis](https://en.wikipedia.org/wiki/Wave_period) |
| wind_speed | m/s | 10-minute average wind speed |
| gust | m/s | Maximum [3-second wind gust](https://glossary.ametsoc.org/wiki/Gust) during the hour |
| atmospheric_pressure | hPa | [Barometric pressure](https://en.wikipedia.org/wiki/Atmospheric_pressure) (970-1030 typical) |
| air_temperature | C | Air temperature at buoy (~3m above sea) |
| sea_temperature | C | [Sea surface temperature](https://en.wikipedia.org/wiki/Sea_surface_temperature) (SST) |

**Why "Significant Wave Height" in the Overview?** The Overview shows Hs (significant wave height) rather than individual wave heights because Hs is the internationally standard measure used for sea state description, forecasting, and ship design. It captures the overall energy of the sea state and matches what a trained observer would estimate visually.

## Row

### Column

#### Station Information

```{r}
create_dt(station_info, "Irish Weather Buoy Network Stations")
```

## Row {height=20%}

### Column

**Data Sources:** [Marine Institute Ireland](https://www.marine.ie/) | [ERDDAP Data Portal](https://erddap.marine.ie/erddap/tabledap/IWBNetwork.html) | [irishbuoys R Package](https://github.com/JohnGavin/irishbuoys)

*Dashboard generated `r generated_time` using irishbuoys v`r pkg_version`*
