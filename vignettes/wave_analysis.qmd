---
title: "Wave Analysis Dashboard"
format:
  dashboard:
    orientation: rows
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false

# Load package
if (requireNamespace("pkgload", quietly = TRUE) && file.exists("../DESCRIPTION")) {
  pkgload::load_all("..", quiet = TRUE)
} else {
  library(irishbuoys)
}

library(dplyr)
library(ggplot2)
library(DT)
library(dygraphs)
library(xts)
library(tidyr)

# Set ggplot theme
theme_set(theme_minimal(base_size = 12))

# Load data from inst/extdata (works during rendering)
load_rds <- function(f) {
  p <- file.path("..", "inst", "extdata", f)
  if (file.exists(p)) return(readRDS(p))
  p <- system.file("extdata", f, package = "irishbuoys")
  if (p != "" && file.exists(p)) return(readRDS(p))
  NULL
}

# Load all data
rogue_events <- load_rds("rogue_wave_events.rds")
rogue_conditions <- rogue_events  # Same data with weather condition fields
analysis_summary <- load_rds("wave_analysis_summary.rds")

seasonal_data <- load_rds("seasonal_analysis.rds")
if (!is.null(seasonal_data)) {
  seasonal_means_wave <- seasonal_data$wave
  seasonal_means_wind <- seasonal_data$wind
  wave_stl <- seasonal_data$stl
} else {
  seasonal_means_wave <- NULL
  seasonal_means_wind <- NULL
  wave_stl <- NULL
}

return_data <- load_rds("return_levels.rds")
if (!is.null(return_data)) {
  return_levels_wave <- return_data$wave
  return_levels_wind <- return_data$wind
  return_levels_hmax <- return_data$hmax
} else {
  return_levels_wave <- NULL
  return_levels_wind <- NULL
  return_levels_hmax <- NULL
}

if (!is.null(analysis_summary)) {
  gust_analysis <- analysis_summary$gust_analysis
  annual_trends_wave <- analysis_summary$trends$annual_wave
} else {
  gust_analysis <- NULL
  annual_trends_wave <- NULL
}

has_data <- !is.null(rogue_events) && nrow(rogue_events) > 0

# Get package version
pkg_version <- tryCatch(
  as.character(packageVersion("irishbuoys")),
  error = function(e) {
    desc_file <- "../DESCRIPTION"
    if (file.exists(desc_file)) {
      desc <- read.dcf(desc_file)
      desc[1, "Version"]
    } else "dev"
  }
)
generated_time <- format(Sys.time(), "%Y-%m-%d %H:%M UTC")

# Helper function for DT tables
create_dt <- function(data, caption = "") {
  time_cols <- which(names(data) %in% c("time", "Time", "timestamp", "Timestamp"))

  dt <- datatable(
    data, caption = caption, filter = 'top', extensions = 'Buttons',
    options = list(
      pageLength = 15, dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel'),
      order = list(list(0, 'desc')), scrollX = TRUE,
      columnDefs = if (length(time_cols) > 0) list(list(width = '120px', targets = time_cols - 1)) else NULL
    ),
    class = 'cell-border stripe hover compact'
  )

  if (length(time_cols) > 0) {
    dt <- dt %>% DT::formatStyle(columns = time_cols, fontSize = '10px', whiteSpace = 'nowrap')
  }
  dt
}

# Helper for dygraphs
create_dygraph <- function(data, x_col, y_col, title = "") {
  if (is.null(data) || nrow(data) == 0) return(NULL)
  ts_data <- xts(data[[y_col]], order.by = data[[x_col]])
  colnames(ts_data) <- y_col

  dygraph(ts_data, main = title, width = "100%") |>
    dyOptions(labelsUTC = TRUE, fillGraph = TRUE, fillAlpha = 0.1, drawGrid = TRUE) |>
    dyRangeSelector(height = 40) |>
    dyCrosshair(direction = "vertical") |>
    dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)
}
```

# Overview

## Row

### Column

**Wave Analysis Dashboard** for the Irish Weather Buoy Network. All analysis computed via `{targets}` pipeline.

::: {.callout-important}
## Rogue Wave Definition
A rogue wave has **Hmax/Hs > 2.0** (ratio of maximum individual wave to significant wave height).
:::

| Metric | Value |
|--------|-------|
| Rogue Wave Events | `r if(has_data) nrow(rogue_events) else "N/A"` |
| Stations Analyzed | `r if(has_data) length(unique(rogue_events$station_id)) else "N/A"` |
| Max Rogue Ratio | `r if(has_data) round(max(rogue_events$rogue_ratio), 2) else "N/A"` |
| Max Hmax Observed | `r if(has_data) round(max(rogue_events$hmax), 1) else "N/A"` m |

*Analysis generated `r generated_time` using irishbuoys v`r pkg_version`*

### Column

#### Key Definitions

| Term | Definition | Reference |
|------|------------|-----------|
| **Hs** | [Significant wave height](https://en.wikipedia.org/wiki/Significant_wave_height): 4× [RMS](https://en.wikipedia.org/wiki/Root_mean_square) of wave elevation |
| **Hmax** | Maximum individual wave height in [17.5-min period](https://www.ocean-sci.net/15/789/2019/) |
| **Rogue Wave** | Hmax/Hs > 2.0 ([Dysthe et al., 2008](https://doi.org/10.1146/annurev.fluid.40.111406.102203)) |
| **GEV** | [Generalized Extreme Value](https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution) distribution |
| **STL** | [Seasonal-Trend decomposition using Loess](https://en.wikipedia.org/wiki/STL_decomposition) |

# Rogue Waves

## Row

### Column {.tabset}

#### All Stations (Plot)

```{r}
#| fig-width: 12
#| fig-height: 6
if (has_data) {
  ggplot(rogue_events, aes(x = time, y = rogue_ratio, color = station_id)) +
    geom_point(alpha = 0.7, size = 2) +
    geom_hline(yintercept = 2.0, linetype = "dashed", color = "red") +
    geom_hline(yintercept = 2.2, linetype = "dotted", color = "darkred") +
    labs(x = "Time", y = "Hmax / Hs Ratio", color = "Station",
         title = paste("Rogue Wave Events (n =", nrow(rogue_events), ")")) +
    theme(legend.position = "bottom")
} else {
  cat("No rogue wave data available. Run targets::tar_make()")
}
```

#### All Stations (Data)

```{r}
if (has_data) {
  rogue_events %>%
    arrange(desc(rogue_ratio)) %>%
    select(time, station_id, wave_height, hmax, rogue_ratio) %>%
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      wave_height = round(wave_height, 2),
      hmax = round(hmax, 2),
      rogue_ratio = round(rogue_ratio, 3)
    ) %>%
    create_dt("All Rogue Wave Events")
}
```

#### M2

```{r}
if (has_data) {
  m2 <- rogue_events[rogue_events$station_id == "M2", ]
  if (nrow(m2) > 0) {
    ggplot(m2, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M2 Rogue Waves (n =", nrow(m2), ")")) +
      theme_minimal()
  } else cat("No rogue waves at M2")
}
```

#### M3

```{r}
if (has_data) {
  m3 <- rogue_events[rogue_events$station_id == "M3", ]
  if (nrow(m3) > 0) {
    ggplot(m3, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M3 Rogue Waves (n =", nrow(m3), ")")) +
      theme_minimal()
  } else cat("No rogue waves at M3")
}
```

#### M4

```{r}
if (has_data) {
  m4 <- rogue_events[rogue_events$station_id == "M4", ]
  if (nrow(m4) > 0) {
    ggplot(m4, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M4 Rogue Waves (n =", nrow(m4), ")")) +
      theme_minimal()
  } else cat("No rogue waves at M4")
}
```

# Weather Conditions

## Row

### Column {.tabset}

#### Wind Speed (Plot)

```{r}
#| fig-width: 12
if (!is.null(rogue_conditions) && "wind_category" %in% names(rogue_conditions)) {
  wind_sum <- rogue_conditions %>%
    group_by(wind_category) %>%
    summarise(n = n(), mean_ratio = mean(rogue_ratio, na.rm = TRUE), .groups = "drop")

  ggplot(wind_sum, aes(x = reorder(wind_category, n), y = n, fill = mean_ratio)) +
    geom_col() + coord_flip() + scale_fill_viridis_c(name = "Mean Ratio") +
    labs(x = "Wind Category", y = "Count", title = "Rogue Waves by Wind Speed") +
    theme_minimal()
} else {
  cat("Weather condition data not available")
}
```

#### Wind Speed (Data)

```{r}
if (!is.null(rogue_conditions) && "wind_category" %in% names(rogue_conditions)) {
  rogue_conditions %>%
    select(any_of(c("time", "station_id", "rogue_ratio", "wind_category", "wind_speed"))) %>%
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      across(where(is.numeric), ~round(., 2))
    ) %>%
    create_dt("Rogue Waves by Wind Conditions")
}
```

#### Season (Plot)

```{r}
#| fig-width: 12
if (!is.null(rogue_conditions) && "season" %in% names(rogue_conditions)) {
  season_sum <- rogue_conditions %>%
    group_by(season) %>%
    summarise(n = n(), mean_hmax = mean(hmax, na.rm = TRUE), .groups = "drop") %>%
    mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Autumn")))

  ggplot(season_sum, aes(x = season, y = n, fill = mean_hmax)) +
    geom_col() + scale_fill_viridis_c(name = "Mean Hmax") +
    labs(x = "Season", y = "Count", title = "Rogue Waves by Season") +
    theme_minimal()
} else {
  cat("Season data not available")
}
```

#### Season (Data)

```{r}
if (!is.null(rogue_conditions) && "season" %in% names(rogue_conditions)) {
  rogue_conditions %>%
    select(any_of(c("time", "station_id", "rogue_ratio", "season", "hmax"))) %>%
    mutate(time = format(time, "%Y-%m-%d %H:%M"), across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Rogue Waves by Season")
}
```

#### Time of Day (Plot)

```{r}
#| fig-width: 12
if (!is.null(rogue_conditions) && "time_of_day" %in% names(rogue_conditions)) {
  tod_sum <- rogue_conditions %>%
    group_by(time_of_day) %>%
    summarise(n = n(), .groups = "drop")

  ggplot(tod_sum, aes(x = time_of_day, y = n)) +
    geom_col(fill = "steelblue") +
    labs(x = "Time of Day", y = "Count", title = "Rogue Waves by Time of Day") +
    theme_minimal()
}
```

# Trends

## Row

### Column {.tabset}

#### Monthly Wave Height (Plot)

```{r}
#| fig-width: 12
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  monthly <- seasonal_means_wave$monthly
  monthly$month_name <- factor(monthly$month_name, levels = month.abb)

  ggplot(monthly, aes(x = month_name, y = mean)) +
    geom_col(fill = "steelblue") +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.3) +
    labs(x = "Month", y = "Mean Hs (m)", title = "Monthly Wave Height") +
    theme_minimal()
} else {
  cat("Seasonal data not available. Run targets::tar_make()")
}
```

#### Monthly Wave (Data)

```{r}
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  seasonal_means_wave$monthly %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Monthly Wave Height Statistics")
}
```

#### Monthly Wind (Plot)

```{r}
#| fig-width: 12
if (!is.null(seasonal_means_wind) && "monthly" %in% names(seasonal_means_wind)) {
  monthly <- seasonal_means_wind$monthly
  monthly$month_name <- factor(monthly$month_name, levels = month.abb)

  ggplot(monthly, aes(x = month_name, y = mean)) +
    geom_col(fill = "darkorange") +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.3) +
    labs(x = "Month", y = "Mean Wind Speed (m/s)", title = "Monthly Wind Speed") +
    theme_minimal()
}
```

#### Annual Trends (Plot)

```{r}
#| fig-width: 12
if (!is.null(annual_trends_wave) && "annual_stats" %in% names(annual_trends_wave)) {
  annual <- annual_trends_wave$annual_stats

  ggplot(annual, aes(x = year, y = mean)) +
    geom_point(size = 3) + geom_line(alpha = 0.5) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.3, alpha = 0.5) +
    geom_smooth(method = "lm", se = TRUE, color = "red", alpha = 0.2) +
    labs(x = "Year", y = "Mean Hs (m)", title = "Annual Wave Height Trend") +
    theme_minimal()
} else {
  cat("Annual trend data not available")
}
```

#### STL Decomposition

```{r}
#| fig-width: 12
#| fig-height: 8
if (!is.null(wave_stl) && "components" %in% names(wave_stl)) {
  stl_df <- wave_stl$components
  stl_long <- tidyr::pivot_longer(stl_df,
    cols = c(original, seasonal, trend, remainder),
    names_to = "component", values_to = "value")
  stl_long$component <- factor(stl_long$component,
    levels = c("original", "trend", "seasonal", "remainder"))

  ggplot(stl_long, aes(x = time, y = value)) +
    geom_line(color = "steelblue", alpha = 0.7) +
    facet_wrap(~component, scales = "free_y", ncol = 1) +
    labs(x = "Time", y = "Wave Height (m)", title = "STL Decomposition") +
    theme_minimal()
} else {
  cat("STL decomposition not available")
}
```

# Extreme Values

## Row

### Column {.tabset}

#### Wave Return Levels (Plot)

```{r}
#| fig-width: 12
if (!is.null(return_levels_wave)) {
  ggplot(return_levels_wave, aes(x = return_period, y = return_level)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, fill = "steelblue") +
    geom_line(color = "steelblue", linewidth = 1.2) +
    geom_point(color = "steelblue", size = 3) +
    scale_x_log10() +
    labs(x = "Return Period (years)", y = "Hs (m)", title = "Wave Height Return Levels") +
    theme_minimal()
} else {
  cat("Return levels not available. Run targets::tar_make()")
}
```

#### Wave Return Levels (Data)

```{r}
if (!is.null(return_levels_wave)) {
  return_levels_wave %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Wave Height Return Levels")
}
```

#### Wind Return Levels (Plot)

```{r}
#| fig-width: 12
if (!is.null(return_levels_wind)) {
  ggplot(return_levels_wind, aes(x = return_period, y = return_level)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, fill = "darkorange") +
    geom_line(color = "darkorange", linewidth = 1.2) +
    geom_point(color = "darkorange", size = 3) +
    scale_x_log10() +
    labs(x = "Return Period (years)", y = "Wind Speed (m/s)", title = "Wind Speed Return Levels") +
    theme_minimal()
}
```

#### Hmax Return Levels (Plot)

```{r}
#| fig-width: 12
if (!is.null(return_levels_hmax)) {
  ggplot(return_levels_hmax, aes(x = return_period, y = return_level)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, fill = "darkred") +
    geom_line(color = "darkred", linewidth = 1.2) +
    geom_point(color = "darkred", size = 3) +
    scale_x_log10() +
    labs(x = "Return Period (years)", y = "Hmax (m)", title = "Maximum Wave Return Levels") +
    theme_minimal()
}
```

#### Summary Table

```{r}
if (!is.null(return_levels_wave)) {
  bind_rows(
    if (!is.null(return_levels_wave)) return_levels_wave %>% mutate(Variable = "Hs") else NULL,
    if (!is.null(return_levels_hmax)) return_levels_hmax %>% mutate(Variable = "Hmax") else NULL,
    if (!is.null(return_levels_wind)) return_levels_wind %>% mutate(Variable = "Wind") else NULL
  ) %>%
    select(Variable, return_period, return_level, lower, upper) %>%
    mutate(across(where(is.numeric), ~round(., 1))) %>%
    create_dt("Return Levels Summary")
}
```

# Gust Factor

## Row

### Column {.tabset}

#### Summary

Gust Factor = Peak Gust / Sustained Wind. Typical value: ~1.3

```{r}
if (!is.null(gust_analysis) && "summary" %in% names(gust_analysis)) {
  gust_analysis$summary %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Gust Factor Statistics")
} else {
  cat("Gust analysis not available. Run targets::tar_make()")
}
```

#### By Wind Category (Plot)

```{r}
#| fig-width: 12
if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_cat <- gust_analysis$by_category

  ggplot(gust_cat, aes(x = wind_category, y = mean_gf)) +
    geom_col(fill = "darkorange") +
    geom_hline(yintercept = 1.3, linetype = "dashed", color = "red") +
    labs(x = "Wind Speed Category", y = "Gust Factor", title = "Gust Factor by Wind Speed") +
    theme_minimal()
}
```

#### By Wind Category (Data)

```{r}
if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_analysis$by_category %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Gust Factor by Wind Category")
}
```

# Reference

## Row

### Column {width=50%}

#### Wave Science Glossary

| Term | Definition | Reference |
|------|------------|-----------|
| **Hs (H₁/₃)** | Significant wave height = mean of highest 1/3 of waves | [Wikipedia](https://en.wikipedia.org/wiki/Significant_wave_height) |
| **Hs = 4σ** | Derived from [Rayleigh distribution](https://en.wikipedia.org/wiki/Rayleigh_distribution) of wave heights | [Longuet-Higgins, 1952](https://doi.org/10.1357/002224052806645438) |
| **RMS** | [Root Mean Square](https://en.wikipedia.org/wiki/Root_mean_square) of wave elevation | H_rms = Hs / √8 |
| **Hmax** | Maximum individual wave in measurement period | Typically Hmax/Hs ≈ 1.5-1.9 |
| **17.5 min** | Standard measurement period for ~100+ waves | [WMO guidelines](https://library.wmo.int/) |
| **Zero-crossing** | Method to identify individual waves in elevation record | [Wave period](https://en.wikipedia.org/wiki/Wave_period) |

### Column {width=50%}

#### Extreme Value Analysis Methods

| Method | Description | Use Case |
|--------|-------------|----------|
| **GEV** | [Generalized Extreme Value](https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution) | Annual maxima |
| **GPD** | [Generalized Pareto](https://en.wikipedia.org/wiki/Generalized_Pareto_distribution) | Peaks over threshold |
| **Return Level** | Value expected to be exceeded once per T years | Design specifications |
| **STL** | [Seasonal-Trend Loess](https://en.wikipedia.org/wiki/STL_decomposition) | Trend detection |

**References:**

- Longuet-Higgins, M.S. (1952). Statistical distribution of sea waves. *J. Marine Research*, 11, 245-266.
- Dysthe, K. et al. (2008). Oceanic rogue waves. *Ann. Rev. Fluid Mech.*, 40, 287-310.
- Coles, S. (2001). *Statistical Modeling of Extreme Values*. Springer.

---

*Analysis generated `r generated_time` using irishbuoys v`r pkg_version`*
