---
title: "Wave Analysis Dashboard"
format:
  dashboard:
    orientation: rows
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false

# Load package
if (requireNamespace("pkgload", quietly = TRUE) && file.exists("../DESCRIPTION")) {
  pkgload::load_all("..", quiet = TRUE)
} else {
  library(irishbuoys)
}

library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(dygraphs)
library(xts)
library(tidyr)

theme_set(theme_minimal(base_size = 12))

# Load data from inst/extdata
load_rds <- function(f) {
  p <- file.path("..", "inst", "extdata", f)
  if (file.exists(p)) return(readRDS(p))
  p <- system.file("extdata", f, package = "irishbuoys")
  if (p != "" && file.exists(p)) return(readRDS(p))
  NULL
}

# Load all data
rogue_events <- load_rds("rogue_wave_events.rds")
rogue_conditions <- rogue_events
analysis_summary <- load_rds("wave_analysis_summary.rds")

seasonal_data <- load_rds("seasonal_analysis.rds")
if (!is.null(seasonal_data)) {
  seasonal_means_wave <- seasonal_data$wave
  seasonal_means_wind <- seasonal_data$wind
  wave_stl <- seasonal_data$stl
} else {
  seasonal_means_wave <- NULL
  seasonal_means_wind <- NULL
  wave_stl <- NULL
}

return_data <- load_rds("return_levels.rds")
if (!is.null(return_data)) {
  return_levels_wave <- return_data$wave
  return_levels_wind <- return_data$wind
  return_levels_hmax <- return_data$hmax
} else {
  return_levels_wave <- NULL
  return_levels_wind <- NULL
  return_levels_hmax <- NULL
}

if (!is.null(analysis_summary)) {
  gust_analysis <- analysis_summary$gust_analysis
  annual_trends_wave <- analysis_summary$trends$annual_wave
} else {
  gust_analysis <- NULL
  annual_trends_wave <- NULL
}

has_data <- !is.null(rogue_events) && nrow(rogue_events) > 0

# Get package version
pkg_version <- tryCatch(
  as.character(packageVersion("irishbuoys")),
  error = function(e) {
    desc_file <- "../DESCRIPTION"
    if (file.exists(desc_file)) {
      desc <- read.dcf(desc_file)
      desc[1, "Version"]
    } else "dev"
  }
)
generated_time <- format(Sys.time(), "%Y-%m-%d %H:%M UTC")

# Helper function for DT tables
create_dt <- function(data, caption = "") {
  time_cols <- which(names(data) %in% c("time", "Time", "timestamp", "Timestamp"))

  dt <- datatable(
    data, caption = caption, filter = 'top', extensions = 'Buttons',
    options = list(
      pageLength = 15, dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel'),
      order = list(list(0, 'desc')), scrollX = TRUE,
      columnDefs = if (length(time_cols) > 0) list(list(width = '120px', targets = time_cols - 1)) else NULL
    ),
    class = 'cell-border stripe hover compact'
  )

  if (length(time_cols) > 0) {
    dt <- dt %>% DT::formatStyle(columns = time_cols, fontSize = '10px', whiteSpace = 'nowrap')
  }
  dt
}

# Beaufort scale classification (wind speed in m/s)
classify_beaufort <- function(ws) {
  cut(ws,
    breaks = c(-Inf, 10.7, 17.1, 24.4, 28.4, 32.6, Inf),
    labels = c("0-5 (Calm-Fresh)", "6-7 (Strong-Near Gale)",
               "8-9 (Gale-Severe)", "10 (Storm)",
               "11 (Violent Storm)", "12 (Hurricane)"),
    right = TRUE
  )
}

beaufort_colors <- c(
  "0-5 (Calm-Fresh)" = "#2166ac",
  "6-7 (Strong-Near Gale)" = "#67a9cf",
  "8-9 (Gale-Severe)" = "#fddbc7",
  "10 (Storm)" = "#ef8a62",
  "11 (Violent Storm)" = "#b2182b",
  "12 (Hurricane)" = "#67001f"
)
```

# Overview

## Row

### Column

**Wave Analysis Dashboard** for the Irish Weather Buoy Network. All analysis computed via `{targets}` pipeline.

::: {.callout-important}
## Rogue Wave Definition
A rogue wave has **Hmax/Hs > 2.0** (ratio of maximum individual wave to significant wave height).
:::

| Metric | Value |
|--------|-------|
| Rogue Wave Events | `r if(has_data) nrow(rogue_events) else "N/A"` |
| Stations Analyzed | `r if(has_data) length(unique(rogue_events$station_id)) else "N/A"` |
| Max Rogue Ratio | `r if(has_data) round(max(rogue_events$rogue_ratio), 2) else "N/A"` |
| Max Hmax Observed | `r if(has_data) round(max(rogue_events$hmax), 1) else "N/A"` m |

*Analysis generated `r generated_time` using irishbuoys v`r pkg_version`*

### Column

#### Key Definitions

| Term | Definition | Reference |
|------|------------|-----------|
| **Hs** | [Significant wave height](https://en.wikipedia.org/wiki/Significant_wave_height): 4x [RMS](https://en.wikipedia.org/wiki/Root_mean_square) of wave elevation |
| **Hmax** | Maximum individual wave height in [17.5-min period](https://www.ocean-sci.net/15/789/2019/) |
| **Rogue Wave** | Hmax/Hs > 2.0 ([Dysthe et al., 2008](https://doi.org/10.1146/annurev.fluid.40.111406.102203)) |
| **GEV** | [Generalized Extreme Value](https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution) distribution |
| **STL** | [Seasonal-Trend decomposition using Loess](https://en.wikipedia.org/wiki/STL_decomposition) |

# Rogue Waves

## Row

### Column {.tabset}

#### All Stations

```{r}
if (has_data) {
  plot_ly(rogue_events, x = ~time, y = ~rogue_ratio, color = ~station_id,
    type = "scatter", mode = "markers",
    marker = list(size = 8, opacity = 0.7),
    text = ~paste0("Station: ", station_id, "<br>",
                   "Time: ", format(time, "%Y-%m-%d %H:%M"), "<br>",
                   "Rogue Ratio: ", round(rogue_ratio, 3), "<br>",
                   "Hmax: ", round(hmax, 2), " m<br>",
                   "Hs: ", round(wave_height, 2), " m<br>",
                   "Wind: ", round(wind_speed, 1), " m/s<br>",
                   "Gust: ", round(gust, 1), " m/s"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste("All Rogue Wave Events (n =", nrow(rogue_events), ")"),
      xaxis = list(title = "Time"),
      yaxis = list(title = "Hmax / Hs Ratio"),
      shapes = list(
        list(type = "line", x0 = min(rogue_events$time), x1 = max(rogue_events$time),
             y0 = 2.0, y1 = 2.0, line = list(color = "red", dash = "dash", width = 2)),
        list(type = "line", x0 = min(rogue_events$time), x1 = max(rogue_events$time),
             y0 = 2.2, y1 = 2.2, line = list(color = "darkred", dash = "dot", width = 1.5))
      ),
      annotations = list(
        list(x = max(rogue_events$time), y = 2.0, text = "Rogue threshold (2.0)",
             showarrow = FALSE, xanchor = "right", yanchor = "bottom", font = list(color = "red", size = 10)),
        list(x = max(rogue_events$time), y = 2.2, text = "Severe (2.2)",
             showarrow = FALSE, xanchor = "right", yanchor = "bottom", font = list(color = "darkred", size = 10))
      )
    )
} else {
  cat("No rogue wave data available. Run targets::tar_make()")
}
```

#### Events by Station

```{r}
if (has_data) {
  # Faceted plotly by station with rogue threshold
  station_counts <- rogue_events |> count(station_id) |> arrange(desc(n))

  p <- ggplot(rogue_events, aes(x = time, y = hmax,
    text = paste0("Station: ", station_id, "<br>",
                  "Time: ", format(time, "%Y-%m-%d %H:%M"), "<br>",
                  "Hmax: ", round(hmax, 2), " m<br>",
                  "Hs: ", round(wave_height, 2), " m<br>",
                  "Ratio: ", round(rogue_ratio, 3), "<br>",
                  "Wind: ", round(wind_speed, 1), " m/s<br>",
                  "Gust: ", round(gust, 1), " m/s<br>",
                  "Pressure: ", round(atmospheric_pressure, 1), " hPa")
  )) +
    geom_point(aes(color = rogue_ratio), size = 3, alpha = 0.8) +
    scale_color_viridis_c(name = "Hmax/Hs") +
    facet_wrap(~station_id, scales = "free_y") +
    labs(x = "Time", y = "Hmax (m)") +
    theme_minimal()

  # Add station-specific rogue thresholds (Hs * 2.0 per observation)
  ggplotly(p, tooltip = "text") |>
    layout(title = "Rogue Wave Events by Station (Hmax)")
}
```

#### Data Table

```{r}
if (has_data) {
  rogue_events |>
    arrange(desc(rogue_ratio)) |>
    select(time, station_id, wave_height, hmax, rogue_ratio, wind_speed, gust, atmospheric_pressure) |>
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      across(where(is.numeric), ~round(., 2))
    ) |>
    create_dt("All Rogue Wave Events (sorted by ratio)")
}
```

# Weather Conditions

## Row

### Column {.tabset}

#### Wind Speed (Beaufort)

```{r}
if (!is.null(rogue_conditions) && "wind_speed" %in% names(rogue_conditions)) {
  rc <- rogue_conditions |>
    mutate(beaufort = classify_beaufort(wind_speed))

  plot_ly(rc, x = ~wind_speed, y = ~rogue_ratio, color = ~beaufort,
    colors = beaufort_colors,
    type = "scatter", mode = "markers",
    marker = list(size = 10, opacity = 0.8,
                  line = list(width = 1, color = "white")),
    text = ~paste0("Station: ", station_id, "<br>",
                   "Time: ", format(time, "%Y-%m-%d %H:%M"), "<br>",
                   "Wind: ", round(wind_speed, 1), " m/s<br>",
                   "Beaufort: ", beaufort, "<br>",
                   "Rogue Ratio: ", round(rogue_ratio, 3), "<br>",
                   "Hmax: ", round(hmax, 2), " m<br>",
                   "Hs: ", round(wave_height, 2), " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Rogue Waves by Wind Speed (Beaufort Scale)",
      xaxis = list(title = "Wind Speed (m/s)"),
      yaxis = list(title = "Hmax / Hs Ratio"),
      shapes = list(
        list(type = "line", x0 = 0, x1 = max(rc$wind_speed, na.rm = TRUE) * 1.05,
             y0 = 2.0, y1 = 2.0, line = list(color = "red", dash = "dash", width = 2))
      ),
      legend = list(title = list(text = "Beaufort Scale"))
    )
} else {
  cat("Wind speed data not available")
}
```

#### Wind Speed (Data)

```{r}
if (!is.null(rogue_conditions) && "wind_speed" %in% names(rogue_conditions)) {
  rogue_conditions |>
    mutate(beaufort = classify_beaufort(wind_speed)) |>
    select(any_of(c("time", "station_id", "rogue_ratio", "wind_speed", "beaufort", "hmax"))) |>
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      across(where(is.numeric), ~round(., 2))
    ) |>
    create_dt("Rogue Waves by Wind Conditions (Beaufort)")
}
```

#### Week of Year

```{r}
if (!is.null(rogue_conditions)) {
  rc <- rogue_conditions |>
    mutate(
      week = as.integer(format(time, "%V")),
      month_name = factor(format(time, "%b"), levels = month.abb)
    )

  week_counts <- rc |>
    group_by(week, month_name) |>
    summarise(
      n = n(),
      mean_ratio = round(mean(rogue_ratio, na.rm = TRUE), 2),
      max_hmax = round(max(hmax, na.rm = TRUE), 1),
      .groups = "drop"
    )

  month_colors <- c(
    "Jan" = "#1f77b4", "Feb" = "#2ca02c", "Mar" = "#bcbd22",
    "Apr" = "#ff7f0e", "May" = "#d62728", "Jun" = "#9467bd",
    "Jul" = "#8c564b", "Aug" = "#e377c2", "Sep" = "#7f7f7f",
    "Oct" = "#17becf", "Nov" = "#aec7e8", "Dec" = "#98df8a"
  )

  plot_ly(week_counts, x = ~week, y = ~n, color = ~month_name,
    colors = month_colors,
    type = "bar",
    text = ~paste0("Week ", week, "<br>",
                   "Month: ", month_name, "<br>",
                   "Rogue Events: ", n, "<br>",
                   "Mean Ratio: ", mean_ratio, "<br>",
                   "Max Hmax: ", max_hmax, " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Rogue Wave Events by Week of Year",
      xaxis = list(title = "Week of Year", dtick = 1),
      yaxis = list(title = "Count of Rogue Events"),
      barmode = "stack",
      legend = list(title = list(text = "Month"))
    )
} else {
  cat("Temporal data not available")
}
```

#### Time of Day

```{r}
if (!is.null(rogue_conditions) && "time_of_day" %in% names(rogue_conditions)) {
  tod_data <- rogue_conditions |>
    group_by(time_of_day) |>
    summarise(
      n = n(),
      mean_ratio = round(mean(rogue_ratio, na.rm = TRUE), 2),
      .groups = "drop"
    )

  plot_ly(tod_data, x = ~time_of_day, y = ~n,
    type = "bar",
    marker = list(color = "steelblue"),
    text = ~paste0("Time of Day: ", time_of_day, "<br>",
                   "Rogue Events: ", n, "<br>",
                   "Mean Ratio: ", mean_ratio),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Rogue Waves by Time of Day",
      xaxis = list(title = "Time of Day"),
      yaxis = list(title = "Count")
    )
}
```

# Wave Science

## Row

### Column {width=50%}

#### Wave Measurement Glossary

| Term | Definition | Reference |
|------|------------|-----------|
| **Hs (H1/3)** | Significant wave height = mean of highest 1/3 of waves | [Wikipedia](https://en.wikipedia.org/wiki/Significant_wave_height) |
| **Hs = 4s** | Derived from [Rayleigh distribution](https://en.wikipedia.org/wiki/Rayleigh_distribution) of wave heights | [Longuet-Higgins, 1952](https://doi.org/10.1357/002224052806645438) |
| **RMS** | [Root Mean Square](https://en.wikipedia.org/wiki/Root_mean_square) of wave elevation | H_rms = Hs / sqrt(8) |
| **Hmax** | Maximum individual wave in measurement period | Typically Hmax/Hs ~ 1.5-1.9 |
| **17.5 min** | Standard measurement period for ~100+ waves | [WMO guidelines](https://library.wmo.int/) |
| **Zero-crossing** | Method to identify individual waves in elevation record | [Wave period](https://en.wikipedia.org/wiki/Wave_period) |

### Column {width=50%}

#### Why Hs = 4 x Standard Deviation

The significant wave height Hs is defined as 4 times the standard deviation of the sea surface elevation. This arises from wave spectrum theory:

- For a narrow-banded wave spectrum, **Hs = 4 x sqrt(m0)** where m0 is the zeroth spectral moment (variance of sea elevation)
- Equivalent to the **mean of the highest 1/3 of waves** (H1/3)
- Matches visual estimates by trained observers at sea
- The factor of 4 comes from the [Rayleigh distribution](https://en.wikipedia.org/wiki/Rayleigh_distribution) of wave heights

**Why 17.5-minute measurement?**

- Statistical requirement: Need ~100+ waves for valid H1/3
- Wave periods typically 5-15 seconds -> 17.5 min gives ~70-200 waves
- WMO recommends 20-30 minutes; 17.5 is the practical lower bound
- Trade-off: longer = better statistics, shorter = more temporal resolution

# Trends

## Row

### Column {.tabset}

#### Monthly Wave Height

```{r}
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  monthly <- seasonal_means_wave$monthly
  monthly$month_name <- factor(monthly$month_name, levels = month.abb)

  plot_ly(monthly, x = ~month_name, y = ~mean,
    type = "bar",
    marker = list(color = "steelblue"),
    error_y = list(type = "data", array = ~sd, color = "gray40"),
    text = ~paste0("Month: ", month_name, "<br>",
                   "Mean Hs: ", round(mean, 2), " m<br>",
                   "SD: ", round(sd, 2), " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Monthly Mean Wave Height",
      xaxis = list(title = "Month"),
      yaxis = list(title = "Mean Hs (m)")
    )
} else {
  cat("Seasonal data not available. Run targets::tar_make()")
}
```

#### Monthly Wave (Data)

```{r}
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  seasonal_means_wave$monthly |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Monthly Wave Height Statistics")
}
```

#### Monthly Wind

```{r}
if (!is.null(seasonal_means_wind) && "monthly" %in% names(seasonal_means_wind)) {
  monthly <- seasonal_means_wind$monthly
  monthly$month_name <- factor(monthly$month_name, levels = month.abb)

  plot_ly(monthly, x = ~month_name, y = ~mean,
    type = "bar",
    marker = list(color = "darkorange"),
    error_y = list(type = "data", array = ~sd, color = "gray40"),
    text = ~paste0("Month: ", month_name, "<br>",
                   "Mean Wind: ", round(mean, 2), " m/s<br>",
                   "SD: ", round(sd, 2), " m/s"),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Monthly Mean Wind Speed",
      xaxis = list(title = "Month"),
      yaxis = list(title = "Mean Wind Speed (m/s)")
    )
}
```

#### Annual Trends

```{r}
if (!is.null(annual_trends_wave) && "annual_stats" %in% names(annual_trends_wave)) {
  annual <- annual_trends_wave$annual_stats

  plot_ly(annual, x = ~year, y = ~mean,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "steelblue"),
    line = list(color = "steelblue"),
    error_y = list(type = "data", array = ~sd, color = "gray60"),
    text = ~paste0("Year: ", year, "<br>",
                   "Mean Hs: ", round(mean, 2), " m<br>",
                   "SD: ", round(sd, 2), " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Annual Wave Height Trend",
      xaxis = list(title = "Year"),
      yaxis = list(title = "Mean Hs (m)")
    )
} else {
  cat("Annual trend data not available")
}
```

#### STL Decomposition

```{r}
#| fig-width: 12
#| fig-height: 8
if (!is.null(wave_stl) && "components" %in% names(wave_stl)) {
  stl_df <- wave_stl$components
  stl_long <- tidyr::pivot_longer(stl_df,
    cols = c(original, seasonal, trend, remainder),
    names_to = "component", values_to = "value")
  stl_long$component <- factor(stl_long$component,
    levels = c("original", "trend", "seasonal", "remainder"))

  ggplot(stl_long, aes(x = time, y = value)) +
    geom_line(color = "steelblue", alpha = 0.7) +
    facet_wrap(~component, scales = "free_y", ncol = 1) +
    labs(x = "Time", y = "Wave Height (m)", title = "STL Decomposition") +
    theme_minimal()
} else {
  cat("STL decomposition not available")
}
```

# Extreme Values

## Row

### Column {.tabset}

#### Wave Return Levels

```{r}
if (!is.null(return_levels_wave)) {
  plot_ly(return_levels_wave, x = ~return_period, y = ~return_level,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "steelblue"),
    line = list(color = "steelblue"),
    text = ~paste0("Return Period: ", return_period, " years<br>",
                   "Hs: ", round(return_level, 2), " m<br>",
                   "95% CI: [", round(lower, 2), ", ", round(upper, 2), "]"),
    hoverinfo = "text",
    name = "Return Level"
  ) |>
    add_ribbons(ymin = ~lower, ymax = ~upper,
      fillcolor = "rgba(70, 130, 180, 0.2)",
      line = list(color = "transparent"),
      name = "95% CI", showlegend = TRUE
    ) |>
    layout(
      title = "Wave Height Return Levels (GEV)",
      xaxis = list(title = "Return Period (years)", type = "log"),
      yaxis = list(title = "Hs (m)")
    )
} else {
  cat("Return levels not available. Run targets::tar_make()")
}
```

#### Wave Return (Data)

```{r}
if (!is.null(return_levels_wave)) {
  return_levels_wave |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Wave Height Return Levels")
}
```

#### Wind Return Levels

```{r}
if (!is.null(return_levels_wind)) {
  plot_ly(return_levels_wind, x = ~return_period, y = ~return_level,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "darkorange"),
    line = list(color = "darkorange"),
    text = ~paste0("Return Period: ", return_period, " years<br>",
                   "Wind: ", round(return_level, 2), " m/s<br>",
                   "95% CI: [", round(lower, 2), ", ", round(upper, 2), "]"),
    hoverinfo = "text",
    name = "Return Level"
  ) |>
    add_ribbons(ymin = ~lower, ymax = ~upper,
      fillcolor = "rgba(255, 140, 0, 0.2)",
      line = list(color = "transparent"),
      name = "95% CI", showlegend = TRUE
    ) |>
    layout(
      title = "Wind Speed Return Levels (GEV)",
      xaxis = list(title = "Return Period (years)", type = "log"),
      yaxis = list(title = "Wind Speed (m/s)")
    )
}
```

#### Hmax Return Levels

```{r}
if (!is.null(return_levels_hmax)) {
  plot_ly(return_levels_hmax, x = ~return_period, y = ~return_level,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "darkred"),
    line = list(color = "darkred"),
    text = ~paste0("Return Period: ", return_period, " years<br>",
                   "Hmax: ", round(return_level, 2), " m<br>",
                   "95% CI: [", round(lower, 2), ", ", round(upper, 2), "]"),
    hoverinfo = "text",
    name = "Return Level"
  ) |>
    add_ribbons(ymin = ~lower, ymax = ~upper,
      fillcolor = "rgba(139, 0, 0, 0.2)",
      line = list(color = "transparent"),
      name = "95% CI", showlegend = TRUE
    ) |>
    layout(
      title = "Maximum Wave Height Return Levels (GEV)",
      xaxis = list(title = "Return Period (years)", type = "log"),
      yaxis = list(title = "Hmax (m)")
    )
}
```

#### Summary Table

```{r}
if (!is.null(return_levels_wave)) {
  bind_rows(
    if (!is.null(return_levels_wave)) return_levels_wave |> mutate(Variable = "Hs") else NULL,
    if (!is.null(return_levels_hmax)) return_levels_hmax |> mutate(Variable = "Hmax") else NULL,
    if (!is.null(return_levels_wind)) return_levels_wind |> mutate(Variable = "Wind") else NULL
  ) |>
    select(Variable, return_period, return_level, lower, upper) |>
    mutate(across(where(is.numeric), ~round(., 1))) |>
    create_dt("Return Levels Summary")
}
```

# Gust Factor

## Row

### Column {.tabset}

#### Summary

Gust Factor = Peak Gust / Sustained Wind. Typical value: ~1.3

```{r}
if (!is.null(gust_analysis) && "summary" %in% names(gust_analysis)) {
  gust_analysis$summary |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor Statistics")
} else {
  cat("Gust analysis not available. Run targets::tar_make()")
}
```

#### By Wind Category

```{r}
if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_cat <- gust_analysis$by_category

  plot_ly(gust_cat, x = ~wind_category, y = ~mean_gf,
    type = "bar",
    marker = list(color = "darkorange"),
    text = ~paste0("Category: ", wind_category, "<br>",
                   "Mean GF: ", round(mean_gf, 2), "<br>",
                   "P95 GF: ", round(p95_gf, 2)),
    hoverinfo = "text"
  ) |>
    layout(
      title = "Gust Factor by Wind Speed Category",
      xaxis = list(title = "Wind Speed Category"),
      yaxis = list(title = "Gust Factor"),
      shapes = list(
        list(type = "line", x0 = -0.5, x1 = nrow(gust_cat) - 0.5,
             y0 = 1.3, y1 = 1.3, line = list(color = "red", dash = "dash", width = 2))
      ),
      annotations = list(
        list(x = nrow(gust_cat) - 1, y = 1.3, text = "Typical (1.3)",
             showarrow = FALSE, yanchor = "bottom", font = list(color = "red", size = 10))
      )
    )
}
```

#### By Wind Category (Data)

```{r}
if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_analysis$by_category |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor by Wind Category")
}
```

# Reference

## Row

### Column {width=50%}

#### Extreme Value Analysis Methods

| Method | Description | Use Case |
|--------|-------------|----------|
| **GEV** | [Generalized Extreme Value](https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution) | Annual maxima |
| **GPD** | [Generalized Pareto](https://en.wikipedia.org/wiki/Generalized_Pareto_distribution) | Peaks over threshold |
| **Return Level** | Value expected to be exceeded once per T years | Design specifications |
| **STL** | [Seasonal-Trend Loess](https://en.wikipedia.org/wiki/STL_decomposition) | Trend detection |

### Column {width=50%}

#### Beaufort Wind Scale

| Beaufort | Description | Wind Speed (m/s) |
|----------|-------------|-------------------|
| 0-5 | Calm to Fresh Breeze | 0 - 10.7 |
| 6-7 | Strong Breeze to Near Gale | 10.8 - 17.1 |
| 8-9 | Gale to Severe Gale | 17.2 - 24.4 |
| 10 | Storm | 24.5 - 28.4 |
| 11 | Violent Storm | 28.5 - 32.6 |
| 12 | Hurricane Force | > 32.7 |

**References:**

- Longuet-Higgins, M.S. (1952). Statistical distribution of sea waves. *J. Marine Research*, 11, 245-266.
- Dysthe, K. et al. (2008). Oceanic rogue waves. *Ann. Rev. Fluid Mech.*, 40, 287-310.
- Coles, S. (2001). *Statistical Modeling of Extreme Values*. Springer.

---

*Analysis generated `r generated_time` using irishbuoys v`r pkg_version`*
