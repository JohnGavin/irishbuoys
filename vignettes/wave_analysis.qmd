---
title: "Comprehensive Wave Analysis"
subtitle: "Irish Weather Buoy Network Data Analysis"
author: "irishbuoys package"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    page-layout: full
    code-fold: true
    code-summary: "Show code"
    fig-width: 10
    fig-height: 6
execute:
  echo: true
  warning: false
  message: false
---

```{r setup}
#| include: false

# Load package
if (requireNamespace("pkgload", quietly = TRUE) && file.exists("../DESCRIPTION")) {
  pkgload::load_all("..", quiet = TRUE)
} else {
  library(irishbuoys)
}

library(dplyr)
library(ggplot2)
library(DT)
library(targets)

# Set ggplot theme
theme_set(theme_minimal(base_size = 12))

# Helper to safely read targets (works in dev and installed)
tar_read_safe <- function(name) {
  store_path <- file.path("..", "_targets")
  if (dir.exists(store_path)) {
    tryCatch(
      targets::tar_read_raw(deparse(substitute(name)), store = store_path),
      error = function(e) NULL
    )
  } else {
    NULL
  }
}

# Helper for DT tables
create_dt <- function(data, caption = "") {
  datatable(
    data,
    caption = caption,
    filter = 'top',
    options = list(
      pageLength = 15,
      order = list(list(0, 'desc')),
      scrollX = TRUE
    ),
    class = 'cell-border stripe hover'
  )
}

# Load targets data
rogue_events <- tar_read_safe(rogue_wave_events)
rogue_conditions <- tar_read_safe(rogue_wave_conditions)
analysis_summary <- tar_read_safe(analysis_summary)
seasonal_means_wave <- tar_read_safe(seasonal_means_wave)
seasonal_means_wind <- tar_read_safe(seasonal_means_wind)
annual_trends_wave <- tar_read_safe(annual_trends_wave)
return_levels_wave <- tar_read_safe(return_levels_wave)
return_levels_hmax <- tar_read_safe(return_levels_hmax)
return_levels_wind <- tar_read_safe(return_levels_wind)
gust_analysis <- tar_read_safe(gust_factor_analysis)
wave_stl <- tar_read_safe(wave_height_seasonal)

# Fallback to inst/extdata if targets not available
if (is.null(rogue_events)) {
  load_rds <- function(f) {
    p <- file.path("..", "inst", "extdata", f)
    if (file.exists(p)) readRDS(p) else NULL
  }
  rogue_events <- load_rds("rogue_wave_events.rds")
  analysis_summary <- load_rds("wave_analysis_summary.rds")
}

has_targets <- !is.null(rogue_events) && nrow(rogue_events) > 0
```

## Overview

This vignette provides comprehensive wave and wind analysis from the Irish Weather Buoy Network using data from the [Marine Institute's ERDDAP server](https://erddap.marine.ie/erddap/tabledap/IWBNetwork.html).

::: {.callout-note}
## Data Pipeline
All analysis is computed via `{targets}` pipeline for reproducibility. Run `targets::tar_make()` to regenerate.
:::

---

## Wave Measurement Science {#wave-science}

::: {.panel-tabset}

### Glossary

```{r glossary}
glossary <- wave_glossary()
create_dt(glossary, "Wave Measurement Terminology - Click columns to sort, use filters to search")
```

### Hs = 4 x Sigma

The relationship **Hs = 4σ** comes from wave spectrum theory (Longuet-Higgins, 1952).

::: {.callout-important}
## Step-by-Step Calculation

1. **Measure** sea surface elevation η(t) over 17.5 minutes
2. **De-trend**: η'(t) = η(t) - mean(η) ← subtract mean from RAW DATA
3. **Calculate σ** = standard deviation of de-meaned elevations
4. **Hs = 4 × σ**
:::

**Why 4?** This is a mathematical constant from the Rayleigh distribution:

$$H_{1/3} = \int_{H_{67\%}}^{\infty} H \cdot f(H) \, dH = 4.004\sigma \approx 4\sigma$$

### RMS Relationship

$$H_{rms} = \frac{H_s}{\sqrt{8}} \approx 0.707 \times H_s$$

### 17.5-Minute Period

| Wave Type | Typical Period | Waves in 17.5 min |
|-----------|---------------|-------------------|
| Wind waves | 3-10 s | 105-350 |
| Swell | 10-25 s | 42-105 |
| Average | ~8 s | ~130 |

WMO minimum: 17 minutes. Marine Institute: 17.5 minutes (lower bound for ~100+ waves).

### Hourly Processing

1. Burst Sampling (17.5 min) → 2. FFT → 3. Hs = 4√m₀, Hmax from zero-crossing → 4. Hourly report

:::

---

## Rogue Wave Analysis {#rogue-waves}

::: {.callout-important}
## Definition
Rogue wave: **Hmax/Hs > 2.0** (or 2.2 strict threshold)
:::

### Events by Station {#events-by-station}

::: {.panel-tabset}

#### All Stations (Plot)

```{r rogue-all-plot}
#| fig-cap: "Rogue wave events across all stations"

if (has_targets && nrow(rogue_events) > 0) {
  ggplot(rogue_events, aes(x = time, y = rogue_ratio, color = station_id)) +
    geom_point(alpha = 0.7, size = 2) +
    geom_hline(yintercept = 2.0, linetype = "dashed", color = "red") +
    geom_hline(yintercept = 2.2, linetype = "dotted", color = "darkred") +
    labs(x = "Time", y = "Hmax / Hs Ratio", color = "Station",
         title = paste("Rogue Wave Events (n =", nrow(rogue_events), ")")) +
    theme(legend.position = "bottom")
} else {
  cat("No rogue wave data available. Run targets::tar_make() to generate.")
}
```

#### All Stations (Data)

```{r rogue-all-table}
if (has_targets && nrow(rogue_events) > 0) {
  rogue_events %>%
    arrange(desc(rogue_ratio)) %>%
    select(time, station_id, hs, hmax, rogue_ratio) %>%
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      hs = round(hs, 2),
      hmax = round(hmax, 2),
      rogue_ratio = round(rogue_ratio, 3)
    ) %>%
    create_dt("All Rogue Wave Events - Click columns to sort")
} else {
  cat("No rogue wave data available.")
}
```

#### M2 (Plot)

```{r rogue-m2-plot}
if (has_targets) {
  m2 <- rogue_events[rogue_events$station_id == "M2", ]
  if (nrow(m2) > 0) {
    ggplot(m2, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M2 Rogue Waves (n =", nrow(m2), ")"))
  } else cat("No rogue waves at M2")
}
```

#### M2 (Data)

```{r rogue-m2-table}
if (has_targets) {
  m2 <- rogue_events[rogue_events$station_id == "M2", ]
  if (nrow(m2) > 0) {
    m2 %>% arrange(desc(rogue_ratio)) %>%
      select(time, hs, hmax, rogue_ratio) %>%
      mutate(
        time = format(time, "%Y-%m-%d %H:%M"),
        across(c(hs, hmax), ~round(., 2)),
        rogue_ratio = round(rogue_ratio, 3)
      ) %>%
      create_dt("M2 Rogue Waves")
  }
}
```

#### M3 (Plot)

```{r rogue-m3-plot}
if (has_targets) {
  m3 <- rogue_events[rogue_events$station_id == "M3", ]
  if (nrow(m3) > 0) {
    ggplot(m3, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M3 Rogue Waves (n =", nrow(m3), ")"))
  } else cat("No rogue waves at M3")
}
```

#### M3 (Data)

```{r rogue-m3-table}
if (has_targets) {
  m3 <- rogue_events[rogue_events$station_id == "M3", ]
  if (nrow(m3) > 0) {
    m3 %>% arrange(desc(rogue_ratio)) %>%
      select(time, hs, hmax, rogue_ratio) %>%
      mutate(time = format(time, "%Y-%m-%d %H:%M"), across(c(hs, hmax), ~round(., 2)), rogue_ratio = round(rogue_ratio, 3)) %>%
      create_dt("M3 Rogue Waves")
  }
}
```

#### M4 (Plot)

```{r rogue-m4-plot}
if (has_targets) {
  m4 <- rogue_events[rogue_events$station_id == "M4", ]
  if (nrow(m4) > 0) {
    ggplot(m4, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M4 Rogue Waves (n =", nrow(m4), ")"))
  } else cat("No rogue waves at M4")
}
```

#### M4 (Data)

```{r rogue-m4-table}
if (has_targets) {
  m4 <- rogue_events[rogue_events$station_id == "M4", ]
  if (nrow(m4) > 0) {
    m4 %>% arrange(desc(rogue_ratio)) %>%
      select(time, hs, hmax, rogue_ratio) %>%
      mutate(time = format(time, "%Y-%m-%d %H:%M"), across(c(hs, hmax), ~round(., 2)), rogue_ratio = round(rogue_ratio, 3)) %>%
      create_dt("M4 Rogue Waves")
  }
}
```

#### M5 (Plot)

```{r rogue-m5-plot}
if (has_targets) {
  m5 <- rogue_events[rogue_events$station_id == "M5", ]
  if (nrow(m5) > 0) {
    ggplot(m5, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M5 Rogue Waves (n =", nrow(m5), ")"))
  } else cat("No rogue waves at M5")
}
```

#### M5 (Data)

```{r rogue-m5-table}
if (has_targets) {
  m5 <- rogue_events[rogue_events$station_id == "M5", ]
  if (nrow(m5) > 0) {
    m5 %>% arrange(desc(rogue_ratio)) %>%
      select(time, hs, hmax, rogue_ratio) %>%
      mutate(time = format(time, "%Y-%m-%d %H:%M"), across(c(hs, hmax), ~round(., 2)), rogue_ratio = round(rogue_ratio, 3)) %>%
      create_dt("M5 Rogue Waves")
  }
}
```

#### M6 (Plot)

```{r rogue-m6-plot}
if (has_targets) {
  m6 <- rogue_events[rogue_events$station_id == "M6", ]
  if (nrow(m6) > 0) {
    ggplot(m6, aes(x = time, y = hmax, color = rogue_ratio)) +
      geom_point(size = 3) + scale_color_viridis_c(name = "Hmax/Hs") +
      labs(x = "Time", y = "Hmax (m)", title = paste("M6 Rogue Waves (n =", nrow(m6), ")"))
  } else cat("No rogue waves at M6")
}
```

#### M6 (Data)

```{r rogue-m6-table}
if (has_targets) {
  m6 <- rogue_events[rogue_events$station_id == "M6", ]
  if (nrow(m6) > 0) {
    m6 %>% arrange(desc(rogue_ratio)) %>%
      select(time, hs, hmax, rogue_ratio) %>%
      mutate(time = format(time, "%Y-%m-%d %H:%M"), across(c(hs, hmax), ~round(., 2)), rogue_ratio = round(rogue_ratio, 3)) %>%
      create_dt("M6 Rogue Waves")
  }
}
```

:::

### By Weather Conditions {#by-weather-conditions}

::: {.panel-tabset}

#### Wind Speed (Plot)

```{r rogue-wind}
if (!is.null(rogue_conditions) && "wind_category" %in% names(rogue_conditions)) {
  wind_sum <- rogue_conditions %>%
    group_by(wind_category) %>%
    summarise(n = n(), mean_ratio = mean(rogue_ratio, na.rm = TRUE), .groups = "drop")

  ggplot(wind_sum, aes(x = reorder(wind_category, n), y = n, fill = mean_ratio)) +
    geom_col() + coord_flip() + scale_fill_viridis_c(name = "Mean Ratio") +
    labs(x = "Wind Category", y = "Count", title = "Rogue Waves by Wind Speed")
} else {
  cat("Weather condition data not available. Run targets::tar_make()")
}
```

#### Wind Speed (Data)

```{r rogue-wind-table}
if (!is.null(rogue_conditions) && "wind_category" %in% names(rogue_conditions)) {
  rogue_conditions %>%
    select(any_of(c("time", "station_id", "rogue_ratio", "wind_category", "wind_speed"))) %>%
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      across(where(is.numeric), ~round(., 2))
    ) %>%
    create_dt("Rogue Waves by Wind Conditions")
}
```

#### Season (Plot)

```{r rogue-season}
if (!is.null(rogue_conditions) && "season" %in% names(rogue_conditions)) {
  season_sum <- rogue_conditions %>%
    group_by(season) %>%
    summarise(n = n(), mean_hmax = mean(hmax, na.rm = TRUE), .groups = "drop") %>%
    mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Autumn")))

  ggplot(season_sum, aes(x = season, y = n, fill = mean_hmax)) +
    geom_col() + scale_fill_viridis_c(name = "Mean Hmax") +
    labs(x = "Season", y = "Count", title = "Rogue Waves by Season")
} else {
  cat("Season data not available")
}
```

#### Season (Data)

```{r rogue-season-table}
if (!is.null(rogue_conditions) && "season" %in% names(rogue_conditions)) {
  rogue_conditions %>%
    select(any_of(c("time", "station_id", "rogue_ratio", "season", "hmax"))) %>%
    mutate(time = format(time, "%Y-%m-%d %H:%M"), across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Rogue Waves by Season")
}
```

#### Time of Day (Plot)

```{r rogue-tod}
if (!is.null(rogue_conditions) && "time_of_day" %in% names(rogue_conditions)) {
  tod_sum <- rogue_conditions %>%
    group_by(time_of_day) %>%
    summarise(n = n(), .groups = "drop")

  ggplot(tod_sum, aes(x = time_of_day, y = n)) +
    geom_col(fill = "steelblue") +
    labs(x = "Time of Day", y = "Count", title = "Rogue Waves by Time of Day")
} else {
  cat("Time of day data not available")
}
```

#### All Conditions (Data)

```{r rogue-conditions-table}
if (!is.null(rogue_conditions)) {
  rogue_conditions %>%
    select(any_of(c("time", "station_id", "rogue_ratio", "wind_category", "season", "time_of_day"))) %>%
    mutate(time = format(time, "%Y-%m-%d %H:%M"), across(where(is.numeric), ~round(., 3))) %>%
    create_dt("All Rogue Wave Conditions")
}
```

:::

---

## Trend Decomposition {#trends}

::: {.panel-tabset}

### Monthly Wave Height (Plot)

```{r seasonal-wave}
if (!is.null(seasonal_means_wave)) {
  if ("monthly" %in% names(seasonal_means_wave)) {
    monthly <- seasonal_means_wave$monthly
    monthly$month_name <- factor(monthly$month_name, levels = month.abb)

    ggplot(monthly, aes(x = month_name, y = mean)) +
      geom_col(fill = "steelblue") +
      geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.3) +
      labs(x = "Month", y = "Mean Hs (m)", title = "Monthly Wave Height")
  }
} else {
  cat("Seasonal data not available. Run targets::tar_make()")
}
```

### Monthly Wave Height (Data)

```{r seasonal-wave-table}
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  seasonal_means_wave$monthly %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Monthly Wave Height Statistics")
}
```

### Monthly Wind Speed (Plot)

```{r seasonal-wind}
if (!is.null(seasonal_means_wind)) {
  if ("monthly" %in% names(seasonal_means_wind)) {
    monthly <- seasonal_means_wind$monthly
    monthly$month_name <- factor(monthly$month_name, levels = month.abb)

    ggplot(monthly, aes(x = month_name, y = mean)) +
      geom_col(fill = "darkorange") +
      geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.3) +
      labs(x = "Month", y = "Mean Wind Speed (m/s)", title = "Monthly Wind Speed")
  }
} else {
  cat("Wind seasonal data not available")
}
```

### Monthly Wind Speed (Data)

```{r seasonal-wind-table}
if (!is.null(seasonal_means_wind) && "monthly" %in% names(seasonal_means_wind)) {
  seasonal_means_wind$monthly %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Monthly Wind Speed Statistics")
}
```

### Annual Trends (Plot)

```{r annual-trends}
if (!is.null(annual_trends_wave) && "annual_stats" %in% names(annual_trends_wave)) {
  annual <- annual_trends_wave$annual_stats

  ggplot(annual, aes(x = year, y = mean)) +
    geom_point(size = 3) + geom_line(alpha = 0.5) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.3, alpha = 0.5) +
    geom_smooth(method = "lm", se = TRUE, color = "red", alpha = 0.2) +
    labs(x = "Year", y = "Mean Hs (m)", title = "Annual Wave Height Trend")
} else {
  cat("Annual trend data not available. Run targets::tar_make()")
}
```

### Annual Trends (Data)

```{r annual-trends-table}
if (!is.null(annual_trends_wave) && "annual_stats" %in% names(annual_trends_wave)) {
  annual_trends_wave$annual_stats %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Annual Wave Height Statistics")
}
```

### STL Decomposition

```{r stl}
#| fig-height: 8

if (!is.null(wave_stl) && "components" %in% names(wave_stl)) {
  stl_df <- wave_stl$components
  stl_long <- tidyr::pivot_longer(stl_df,
    cols = c(original, seasonal, trend, remainder),
    names_to = "component", values_to = "value")
  stl_long$component <- factor(stl_long$component,
    levels = c("original", "trend", "seasonal", "remainder"))

  ggplot(stl_long, aes(x = time, y = value)) +
    geom_line(color = "steelblue", alpha = 0.7) +
    facet_wrap(~component, scales = "free_y", ncol = 1) +
    labs(x = "Time", y = "Wave Height (m)", title = "STL Decomposition")
} else {
  cat("STL decomposition not available")
}
```

:::

---

## Extreme Value Analysis {#eva}

::: {.panel-tabset}

### Wave Height Return Levels (Plot)

```{r return-wave}
if (!is.null(return_levels_wave)) {
  ggplot(return_levels_wave, aes(x = return_period, y = return_level)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, fill = "steelblue") +
    geom_line(color = "steelblue", linewidth = 1.2) +
    geom_point(color = "steelblue", size = 3) +
    scale_x_log10() +
    labs(x = "Return Period (years)", y = "Hs (m)", title = "Wave Height Return Levels")
} else {
  cat("Return levels not available. Run targets::tar_make()")
}
```

### Wave Height Return Levels (Data)

```{r return-wave-table}
if (!is.null(return_levels_wave)) {
  return_levels_wave %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Wave Height Return Levels")
}
```

### Hmax Return Levels (Plot)

```{r return-hmax}
if (!is.null(return_levels_hmax)) {
  ggplot(return_levels_hmax, aes(x = return_period, y = return_level)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, fill = "darkred") +
    geom_line(color = "darkred", linewidth = 1.2) +
    geom_point(color = "darkred", size = 3) +
    scale_x_log10() +
    labs(x = "Return Period (years)", y = "Hmax (m)", title = "Maximum Wave Return Levels")
} else {
  cat("Hmax return levels not available")
}
```

### Hmax Return Levels (Data)

```{r return-hmax-table}
if (!is.null(return_levels_hmax)) {
  return_levels_hmax %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Hmax Return Levels")
}
```

### Wind Return Levels (Plot)

```{r return-wind}
if (!is.null(return_levels_wind)) {
  ggplot(return_levels_wind, aes(x = return_period, y = return_level)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, fill = "darkorange") +
    geom_line(color = "darkorange", linewidth = 1.2) +
    geom_point(color = "darkorange", size = 3) +
    scale_x_log10() +
    labs(x = "Return Period (years)", y = "Wind Speed (m/s)", title = "Wind Speed Return Levels")
} else {
  cat("Wind return levels not available")
}
```

### Wind Return Levels (Data)

```{r return-wind-table}
if (!is.null(return_levels_wind)) {
  return_levels_wind %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Wind Return Levels")
}
```

### Summary Table

```{r return-summary}
if (!is.null(return_levels_wave) && !is.null(return_levels_hmax)) {
  bind_rows(
    return_levels_wave %>% mutate(Variable = "Hs"),
    return_levels_hmax %>% mutate(Variable = "Hmax"),
    if (!is.null(return_levels_wind)) return_levels_wind %>% mutate(Variable = "Wind") else NULL
  ) %>%
    select(Variable, return_period, return_level, lower, upper) %>%
    mutate(across(where(is.numeric), ~round(., 1))) %>%
    create_dt("Return Levels Summary")
}
```

:::

---

## Gust Factor Analysis {#rogue-wind}

::: {.panel-tabset}

### Summary

Gust Factor = Peak Gust / Sustained Wind. Typical value: ~1.3

```{r gust-summary}
if (!is.null(gust_analysis) && "summary" %in% names(gust_analysis)) {
  gust_analysis$summary %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Gust Factor Statistics")
} else {
  cat("Gust analysis not available. Run targets::tar_make()")
}
```

### By Wind Category (Plot)

```{r gust-category}
if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_cat <- gust_analysis$by_category

  ggplot(gust_cat, aes(x = wind_category, y = mean_gf)) +
    geom_col(fill = "darkorange") +
    geom_hline(yintercept = 1.3, linetype = "dashed", color = "red") +
    labs(x = "Wind Speed Category", y = "Gust Factor",
         title = "Gust Factor by Wind Speed")
}
```

### By Wind Category (Data)

```{r gust-category-table}
if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_analysis$by_category %>%
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    create_dt("Gust Factor by Wind Category")
}
```

:::

---

## Technical Appendix

### Pipeline Status

```{r pipeline-status}
store_path <- file.path("..", "_targets")
if (dir.exists(store_path)) {
  cat("Targets store found at:", normalizePath(store_path), "\n")
  tryCatch({
    meta <- targets::tar_meta(store = store_path)
    cat("Total targets:", nrow(meta), "\n")
    cat("Completed:", sum(meta$error == FALSE, na.rm = TRUE), "\n")
  }, error = function(e) cat("Could not read targets metadata\n"))
} else {
  cat("No targets store found. Run targets::tar_make() to generate analysis.\n")
}
```

### Session Info

```{r session-info}
sessionInfo()
```

### References

1. Longuet-Higgins, M.S. (1952). On the statistical distribution of sea waves. *J. Marine Research*, 11, 245-266.
2. Dysthe, K. et al. (2008). Oceanic rogue waves. *Ann. Rev. Fluid Mech.*, 40, 287-310.
3. Coles, S. (2001). *Statistical Modeling of Extreme Values*. Springer.
