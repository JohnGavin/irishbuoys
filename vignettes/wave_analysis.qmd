---
title: "Wave Analysis Dashboard"
format:
  dashboard:
    orientation: rows
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false

# Load package
if (requireNamespace("pkgload", quietly = TRUE) && file.exists("../DESCRIPTION")) {
  pkgload::load_all("..", quiet = TRUE)
} else {
  library(irishbuoys)
}

library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(dygraphs)
library(xts)
library(tidyr)

theme_set(theme_minimal(base_size = 12))

# Load data from inst/extdata
load_rds <- function(f) {
  p <- file.path("..", "inst", "extdata", f)
  if (file.exists(p)) return(readRDS(p))
  p <- system.file("extdata", f, package = "irishbuoys")
  if (p != "" && file.exists(p)) return(readRDS(p))
  NULL
}

# Load all data
rogue_events <- load_rds("rogue_wave_events.rds")
rogue_conditions <- rogue_events
analysis_summary <- load_rds("wave_analysis_summary.rds")

seasonal_data <- load_rds("seasonal_analysis.rds")
if (!is.null(seasonal_data)) {
  seasonal_means_wave <- seasonal_data$wave
  seasonal_means_wind <- seasonal_data$wind
  wave_stl <- seasonal_data$stl
} else {
  seasonal_means_wave <- NULL
  seasonal_means_wind <- NULL
  wave_stl <- NULL
}

return_data <- load_rds("return_levels.rds")
if (!is.null(return_data)) {
  return_levels_wave <- return_data$wave
  return_levels_wind <- return_data$wind
  return_levels_hmax <- return_data$hmax
} else {
  return_levels_wave <- NULL
  return_levels_wind <- NULL
  return_levels_hmax <- NULL
}

if (!is.null(analysis_summary)) {
  gust_analysis <- analysis_summary$gust_analysis
  annual_trends_wave <- analysis_summary$trends$annual_wave
} else {
  gust_analysis <- NULL
  annual_trends_wave <- NULL
}

has_data <- !is.null(rogue_events) && nrow(rogue_events) > 0

# Get dataset date range for captions
if (!is.null(analysis_summary) && "data_summary" %in% names(analysis_summary)) {
  data_start <- format(analysis_summary$data_summary$date_range[1], "%Y-%m-%d")
  data_end <- format(analysis_summary$data_summary$date_range[2], "%Y-%m-%d")
  date_caption <- paste0(data_start, " to ", data_end)
} else if (has_data) {
  data_start <- format(min(rogue_events$time), "%Y-%m-%d")
  data_end <- format(max(rogue_events$time), "%Y-%m-%d")
  date_caption <- paste0(data_start, " to ", data_end)
} else {
  data_start <- "N/A"
  data_end <- "N/A"
  date_caption <- "N/A"
}

# Get package version
pkg_version <- tryCatch(
  as.character(packageVersion("irishbuoys")),
  error = function(e) {
    desc_file <- "../DESCRIPTION"
    if (file.exists(desc_file)) {
      desc <- read.dcf(desc_file)
      desc[1, "Version"]
    } else "dev"
  }
)
generated_time <- format(Sys.time(), "%Y-%m-%d %H:%M UTC")

# Helper function for DT tables
create_dt <- function(data, caption = "") {
  time_cols <- which(names(data) %in% c("time", "Time", "timestamp", "Timestamp"))

  dt <- datatable(
    data, caption = caption, filter = 'top', extensions = 'Buttons',
    options = list(
      pageLength = 15, dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel'),
      order = list(list(0, 'desc')), scrollX = TRUE,
      columnDefs = if (length(time_cols) > 0) list(list(width = '120px', targets = time_cols - 1)) else NULL
    ),
    class = 'cell-border stripe hover compact'
  )

  if (length(time_cols) > 0) {
    dt <- dt %>% DT::formatStyle(columns = time_cols, fontSize = '10px', whiteSpace = 'nowrap')
  }
  dt
}

# Beaufort scale classification (wind speed in m/s)
classify_beaufort <- function(ws) {
  cut(ws,
    breaks = c(-Inf, 10.7, 17.1, 24.4, 28.4, 32.6, Inf),
    labels = c("0-5 (Calm-Fresh)", "6-7 (Strong-Near Gale)",
               "8-9 (Gale-Severe)", "10 (Storm)",
               "11 (Violent Storm)", "12 (Hurricane)"),
    right = TRUE
  )
}

beaufort_colors <- c(
  "0-5 (Calm-Fresh)" = "#2166ac",
  "6-7 (Strong-Near Gale)" = "#4393c3",
  "8-9 (Gale-Severe)" = "#d6604d",
  "10 (Storm)" = "#f4a582",
  "11 (Violent Storm)" = "#b2182b",
  "12 (Hurricane)" = "#67001f"
)

# Common legend styling for all plotly plots
legend_style <- list(
  font = list(color = "#333333", size = 12),
  bgcolor = "rgba(255,255,255,0.9)",
  bordercolor = "#cccccc",
  borderwidth = 1
)
```

# Overview

## Row

### Column

**Wave Analysis Dashboard** for the Irish Weather Buoy Network. All analysis computed via `{targets}` pipeline.

::: {.callout-important}
## Rogue Wave Definition
A rogue wave has **Hmax/Hs > 2.0** (ratio of maximum individual wave to significant wave height).
:::

| Metric | Value |
|--------|-------|
| Rogue Wave Events | `r if(has_data) nrow(rogue_events) else "N/A"` |
| Stations Analyzed | `r if(has_data) length(unique(rogue_events$station_id)) else "N/A"` |
| Max Rogue Ratio | `r if(has_data) round(max(rogue_events$rogue_ratio), 2) else "N/A"` |
| Max Hmax Observed | `r if(has_data) round(max(rogue_events$hmax), 1) else "N/A"` m |
| Dataset Start | `r if(has_data) format(min(rogue_events$time), "%Y-%m-%d %H:%M UTC") else "N/A"` |
| Dataset End | `r if(has_data) format(max(rogue_events$time), "%Y-%m-%d %H:%M UTC") else "N/A"` |
| Days in Dataset | `r if(has_data) round(as.numeric(difftime(max(rogue_events$time), min(rogue_events$time), units="days"))) else "N/A"` |

*Analysis generated `r generated_time` using irishbuoys v`r pkg_version`*

### Column

#### Key Definitions

| Term | Definition |
|------|------------|
| **Hs** | [Significant wave height](https://en.wikipedia.org/wiki/Significant_wave_height): 4x [RMS](https://en.wikipedia.org/wiki/Root_mean_square) of wave elevation |
| **Hmax** | Maximum individual wave height in [17.5-min period](https://www.ocean-sci.net/15/789/2019/) |
| **Rogue Wave** | Hmax/Hs > 2.0 ([Dysthe et al., 2008](https://doi.org/10.1146/annurev.fluid.40.111406.102203)) |
| **GEV** | [Generalized Extreme Value](https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution) distribution |
| **STL** | [Seasonal-Trend decomposition using Loess](https://en.wikipedia.org/wiki/STL_decomposition) |

# Rogue Waves

## Row

### Column {.tabset}

#### All Stations

```{r}
if (has_data) {
  plot_ly(rogue_events, x = ~time, y = ~rogue_ratio, color = ~station_id,
    type = "scatter", mode = "markers",
    marker = list(size = 8, opacity = 0.7),
    text = ~paste0("Station: ", station_id, "<br>",
                   "Time: ", format(time, "%Y-%m-%d %H:%M"), "<br>",
                   "Rogue Ratio: ", round(rogue_ratio, 3), "<br>",
                   "Hmax: ", round(hmax, 2), " m<br>",
                   "Hs: ", round(wave_height, 2), " m<br>",
                   "Wind: ", round(wind_speed, 1), " m/s<br>",
                   "Gust: ", round(gust, 1), " m/s"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("All Rogue Wave Events (n=", nrow(rogue_events),
                     ", ", format(min(rogue_events$time), "%Y-%m-%d"),
                     " to ", format(max(rogue_events$time), "%Y-%m-%d"), ")"),
      xaxis = list(title = "Time"),
      yaxis = list(title = "Hmax / Hs Ratio"),
      shapes = list(
        list(type = "line", x0 = min(rogue_events$time), x1 = max(rogue_events$time),
             y0 = 2.0, y1 = 2.0, line = list(color = "red", dash = "dash", width = 2)),
        list(type = "line", x0 = min(rogue_events$time), x1 = max(rogue_events$time),
             y0 = 2.2, y1 = 2.2, line = list(color = "darkred", dash = "dot", width = 1.5))
      ),
      annotations = list(
        list(x = max(rogue_events$time), y = 2.0, text = "Rogue threshold (2.0)",
             showarrow = FALSE, xanchor = "right", yanchor = "bottom", font = list(color = "red", size = 10)),
        list(x = max(rogue_events$time), y = 2.2, text = "Severe (2.2)",
             showarrow = FALSE, xanchor = "right", yanchor = "bottom", font = list(color = "darkred", size = 10))
      ),
      plot_bgcolor = "#f8f8f8",
      legend = list(
        font = list(color = "#333333", size = 12),
        bgcolor = "rgba(255,255,255,0.9)",
        bordercolor = "#cccccc", borderwidth = 1
      ),
      hoverlabel = list(bgcolor = "white", font = list(color = "black", size = 12))
    )
} else {
  cat("No rogue wave data available. Run targets::tar_make()")
}
```

#### Events by Station

Use the **range slider** at the bottom to zoom all panels to a specific time period.

```{r}
#| fig-height: 14
if (has_data) {
  stations <- sort(unique(rogue_events$station_id))

  # Color scale for rogue ratio (dark on light background)
  station_colors <- c(M2 = "#e41a1c", M3 = "#377eb8", M4 = "#4daf4a",
                      M5 = "#984ea3", M6 = "#ff7f00")

  plots <- lapply(seq_along(stations), function(i) {
    st <- stations[i]
    d <- rogue_events |> dplyr::filter(station_id == st)
    n_st <- nrow(d)

    plot_ly(d, x = ~time, y = ~hmax,
      type = "scatter", mode = "markers",
      marker = list(
        size = 8, opacity = 0.85,
        color = station_colors[st],
        line = list(width = 0.5, color = "black")
      ),
      text = ~paste0("Station: ", station_id, "<br>",
                     "Time: ", format(time, "%Y-%m-%d %H:%M"), "<br>",
                     "Hmax: ", round(hmax, 2), " m<br>",
                     "Hs: ", round(wave_height, 2), " m<br>",
                     "Ratio: ", round(rogue_ratio, 3), "<br>",
                     "Wind: ", round(wind_speed, 1), " m/s"),
      hoverinfo = "text",
      showlegend = FALSE
    ) |>
      layout(
        annotations = list(list(
          text = paste0("<b>", st, "</b> (n=", n_st, ")"),
          x = 0.02, y = 0.95, xref = "paper", yref = "paper",
          showarrow = FALSE, font = list(size = 13, color = station_colors[st])
        )),
        yaxis = list(title = "Hmax (m)")
      )
  })

  subplot(plots, nrows = length(stations), shareX = TRUE, titleY = TRUE) |>
    layout(
      title = list(
        text = paste0("Rogue Wave Events by Station (n=", nrow(rogue_events),
                      ", ", date_caption, ")"),
        font = list(size = 14)
      ),
      xaxis = list(
        title = "Time",
        rangeslider = list(type = "date", thickness = 0.05)
      ),
      plot_bgcolor = "#f8f8f8",
      hoverlabel = list(bgcolor = "white", font = list(color = "black", size = 12))
    )
}
```

#### Data Table

```{r}
if (has_data) {
  rogue_events |>
    arrange(desc(rogue_ratio)) |>
    select(time, station_id, wave_height, hmax, rogue_ratio, wind_speed, gust, atmospheric_pressure) |>
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      across(where(is.numeric), ~round(., 2))
    ) |>
    create_dt(paste0("All Rogue Wave Events (sorted by ratio, ",
                     format(min(rogue_events$time), "%Y-%m-%d"), " to ",
                     format(max(rogue_events$time), "%Y-%m-%d"), ")"))
}
```

# Weather Conditions

## Row

### Column {.tabset}

#### Wind Speed (Beaufort)

Wind speed in m/s, colored by [Beaufort scale](https://en.wikipedia.org/wiki/Beaufort_scale) category.
Conversion: Beaufort 6 = 10.8 m/s, 8 = 17.2 m/s, 10 = 24.5 m/s, 12 = 32.7 m/s.

```{r}
if (!is.null(rogue_conditions) && "wind_speed" %in% names(rogue_conditions)) {
  rc <- rogue_conditions |>
    mutate(beaufort = classify_beaufort(wind_speed))

  plot_ly(rc, x = ~wind_speed, y = ~rogue_ratio, color = ~beaufort,
    colors = beaufort_colors,
    type = "scatter", mode = "markers",
    marker = list(size = 10, opacity = 0.8,
                  line = list(width = 1, color = "#333333")),
    text = ~paste0("Station: ", station_id, "<br>",
                   "Time: ", format(time, "%Y-%m-%d %H:%M"), "<br>",
                   "Wind: ", round(wind_speed, 1), " m/s<br>",
                   "Beaufort: ", beaufort, "<br>",
                   "Rogue Ratio: ", round(rogue_ratio, 3), "<br>",
                   "Hmax: ", round(hmax, 2), " m<br>",
                   "Hs: ", round(wave_height, 2), " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Rogue Waves by Wind Speed (", date_caption, ")"),
      xaxis = list(title = "Wind Speed (m/s)"),
      yaxis = list(title = "Hmax / Hs Ratio"),
      plot_bgcolor = "#f8f8f8",
      shapes = list(
        list(type = "line", x0 = 0, x1 = max(rc$wind_speed, na.rm = TRUE) * 1.05,
             y0 = 2.0, y1 = 2.0, line = list(color = "red", dash = "dash", width = 2))
      ),
      legend = list(
        title = list(text = "<b>Beaufort Scale</b>",
                     font = list(color = "#333333", size = 13)),
        font = list(color = "#333333", size = 12),
        bgcolor = "rgba(255,255,255,0.9)",
        bordercolor = "#cccccc", borderwidth = 1,
        orientation = "h", y = -0.15, x = 0.5, xanchor = "center"
      ),
      hoverlabel = list(bgcolor = "white", font = list(color = "black", size = 12))
    )
} else {
  cat("Wind speed data not available")
}
```

#### Wind Speed (Data)

```{r}
if (!is.null(rogue_conditions) && "wind_speed" %in% names(rogue_conditions)) {
  rogue_conditions |>
    mutate(beaufort = classify_beaufort(wind_speed)) |>
    select(any_of(c("time", "station_id", "rogue_ratio", "wind_speed", "beaufort", "hmax"))) |>
    mutate(
      time = format(time, "%Y-%m-%d %H:%M"),
      across(where(is.numeric), ~round(., 2))
    ) |>
    create_dt("Rogue Waves by Wind Conditions (Beaufort)")
}
```

#### Week of Year

```{r}
if (!is.null(rogue_conditions)) {
  rc <- rogue_conditions |>
    mutate(
      week = as.integer(format(time, "%V")),
      month_name = factor(format(time, "%b"), levels = month.abb)
    )

  week_counts <- rc |>
    group_by(week, month_name) |>
    summarise(
      n = n(),
      mean_ratio = round(mean(rogue_ratio, na.rm = TRUE), 2),
      max_hmax = round(max(hmax, na.rm = TRUE), 1),
      .groups = "drop"
    )

  # Distinct, high-contrast colors for 12 months
  month_colors <- c(
    "Jan" = "#1f77b4", "Feb" = "#2ca02c", "Mar" = "#8c564b",
    "Apr" = "#ff7f0e", "May" = "#d62728", "Jun" = "#9467bd",
    "Jul" = "#e377c2", "Aug" = "#17becf", "Sep" = "#7f7f7f",
    "Oct" = "#393b79", "Nov" = "#637939", "Dec" = "#8c6d31"
  )

  plot_ly(week_counts, x = ~week, y = ~n, color = ~month_name,
    colors = month_colors,
    type = "bar",
    text = ~paste0("Week ", week, "<br>",
                   "Month: ", month_name, "<br>",
                   "Rogue Events: ", n, "<br>",
                   "Mean Ratio: ", mean_ratio, "<br>",
                   "Max Hmax: ", max_hmax, " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Rogue Wave Events by Week of Year (n=",
                     nrow(rogue_conditions), ", ", date_caption, ")"),
      xaxis = list(title = "Week of Year", dtick = 2),
      yaxis = list(title = "Count of Rogue Events"),
      plot_bgcolor = "#f8f8f8",
      barmode = "stack",
      legend = list(
        title = list(text = "<b>Month</b>",
                     font = list(color = "#333333", size = 13)),
        font = list(color = "#333333", size = 12),
        bgcolor = "rgba(255,255,255,0.9)",
        bordercolor = "#cccccc", borderwidth = 1
      ),
      hoverlabel = list(bgcolor = "white", font = list(color = "black", size = 12))
    )
} else {
  cat("Temporal data not available")
}
```

#### Time of Day

```{r}
if (!is.null(rogue_conditions) && "time_of_day" %in% names(rogue_conditions)) {
  # Order time of day logically
  rogue_conditions$time_of_day <- factor(rogue_conditions$time_of_day,
    levels = c("Morning", "Afternoon", "Evening", "Night"))

  tod_data <- rogue_conditions |>
    group_by(time_of_day) |>
    summarise(
      n = n(),
      hours = dplyr::case_when(
        time_of_day[1] == "Morning" ~ "06:00-12:00",
        time_of_day[1] == "Afternoon" ~ "12:00-18:00",
        time_of_day[1] == "Evening" ~ "18:00-22:00",
        time_of_day[1] == "Night" ~ "22:00-06:00"
      ),
      n_hours = dplyr::case_when(
        time_of_day[1] == "Morning" ~ 6L,
        time_of_day[1] == "Afternoon" ~ 6L,
        time_of_day[1] == "Evening" ~ 4L,
        time_of_day[1] == "Night" ~ 8L
      ),
      rate_per_hour = round(n / n_hours, 1),
      mean_ratio = round(mean(rogue_ratio, na.rm = TRUE), 2),
      .groups = "drop"
    )

  tod_colors <- c(Morning = "#f4a582", Afternoon = "#d6604d",
                  Evening = "#4393c3", Night = "#2166ac")

  total_events <- sum(tod_data$n)

  plot_ly(tod_data, x = ~time_of_day, y = ~n,
    type = "bar",
    marker = list(color = ~tod_colors[as.character(time_of_day)]),
    text = ~paste0(time_of_day, " (", hours, ")<br>",
                   "Events: ", n, "<br>",
                   "Rate: ", rate_per_hour, " events/hour<br>",
                   "Mean Ratio: ", mean_ratio),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Rogue Waves by Time of Day (Total: ", total_events,
                     " events, ", date_caption, ")"),
      xaxis = list(title = "Time of Day (hover for hours)"),
      yaxis = list(title = "Count"),
      plot_bgcolor = "#f8f8f8",
      hoverlabel = list(bgcolor = "white", font = list(color = "black", size = 12)),
      annotations = list(list(
        text = paste0("Total: ", total_events, " rogue events"),
        x = 0.98, y = 0.98, xref = "paper", yref = "paper",
        showarrow = FALSE, font = list(color = "#333333", size = 11)
      ))
    )
}
```

# Wave Science

## Row

### Column {width=50%}

#### Wave Measurement Glossary

| Term | Definition | Reference |
|------|------------|-----------|
| **Hs (H1/3)** | Significant wave height = mean of highest 1/3 of waves | [Wikipedia](https://en.wikipedia.org/wiki/Significant_wave_height) |
| **Hs = 4s** | Derived from [Rayleigh distribution](https://en.wikipedia.org/wiki/Rayleigh_distribution) of wave heights | [Longuet-Higgins, 1952](https://doi.org/10.1357/002224052806645438) |
| **RMS** | [Root Mean Square](https://en.wikipedia.org/wiki/Root_mean_square) of wave elevation | H_rms = Hs / sqrt(8) |
| **Hmax** | Maximum individual wave in measurement period | Typically Hmax/Hs ~ 1.5-1.9 |
| **17.5 min** | Standard measurement period for ~100+ waves | [WMO guidelines](https://library.wmo.int/) |
| **Zero-crossing** | Method to identify individual waves in elevation record | [Wave period](https://en.wikipedia.org/wiki/Wave_period) |

### Column {width=50%}

#### Why Hs = 4 x Standard Deviation

The significant wave height Hs is defined as 4 times the standard deviation of the sea surface elevation. This arises from wave spectrum theory:

- For a narrow-banded wave spectrum, **Hs = 4 x sqrt(m0)** where m0 is the zeroth spectral moment (variance of sea elevation)
- Equivalent to the **mean of the highest 1/3 of waves** (H1/3)
- Matches visual estimates by trained observers at sea
- The factor of 4 comes from the [Rayleigh distribution](https://en.wikipedia.org/wiki/Rayleigh_distribution) of wave heights

**Why 17.5-minute measurement?**

- Statistical requirement: Need ~100+ waves for valid H1/3
- Wave periods typically 5-15 seconds -> 17.5 min gives ~70-200 waves
- WMO recommends 20-30 minutes; 17.5 is the practical lower bound
- Trade-off: longer = better statistics, shorter = more temporal resolution

# Trends

## Row

### Column {.tabset}

#### Monthly Wave Height

```{r}
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  monthly <- seasonal_means_wave$monthly
  monthly$month_name <- factor(monthly$month_name, levels = month.abb)

  plot_ly(monthly, x = ~month_name, y = ~mean,
    type = "bar",
    marker = list(color = "steelblue"),
    error_y = list(type = "data", array = ~sd, color = "gray40"),
    text = ~paste0("Month: ", month_name, "<br>",
                   "Mean Hs: ", round(mean, 2), " m<br>",
                   "SD: ", round(sd, 2), " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Monthly Mean Wave Height (", date_caption, ")"),
      xaxis = list(title = "Month"),
      yaxis = list(title = "Mean Hs (m)")
    )
} else {
  cat("Seasonal data not available. Run targets::tar_make()")
}
```

#### Monthly Wave (Data)

```{r}
if (!is.null(seasonal_means_wave) && "monthly" %in% names(seasonal_means_wave)) {
  seasonal_means_wave$monthly |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt(paste0("Monthly Wave Height Statistics (", date_caption, ")"))
}
```

#### Monthly Wind

```{r}
if (!is.null(seasonal_means_wind) && "monthly" %in% names(seasonal_means_wind)) {
  monthly <- seasonal_means_wind$monthly
  monthly$month_name <- factor(monthly$month_name, levels = month.abb)

  plot_ly(monthly, x = ~month_name, y = ~mean,
    type = "bar",
    marker = list(color = "darkorange"),
    error_y = list(type = "data", array = ~sd, color = "gray40"),
    text = ~paste0("Month: ", month_name, "<br>",
                   "Mean Wind: ", round(mean, 2), " m/s<br>",
                   "SD: ", round(sd, 2), " m/s"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Monthly Mean Wind Speed (", date_caption, ")"),
      xaxis = list(title = "Month"),
      yaxis = list(title = "Mean Wind Speed (m/s)")
    )
}
```

#### Annual Trends

```{r}
if (!is.null(annual_trends_wave) && "annual_stats" %in% names(annual_trends_wave)) {
  annual <- annual_trends_wave$annual_stats

  plot_ly(annual, x = ~year, y = ~mean,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "steelblue"),
    line = list(color = "steelblue"),
    error_y = list(type = "data", array = ~sd, color = "gray60"),
    text = ~paste0("Year: ", year, "<br>",
                   "Mean Hs: ", round(mean, 2), " m<br>",
                   "SD: ", round(sd, 2), " m"),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Annual Wave Height Trend (", date_caption, ")"),
      xaxis = list(title = "Year"),
      yaxis = list(title = "Mean Hs (m)")
    )
} else {
  cat("Annual trend data not available")
}
```

#### STL Decomposition

```{r}
#| fig-width: 12
#| fig-height: 8
if (!is.null(wave_stl) && "components" %in% names(wave_stl)) {
  stl_df <- wave_stl$components
  stl_long <- tidyr::pivot_longer(stl_df,
    cols = c(original, seasonal, trend, remainder),
    names_to = "component", values_to = "value")
  stl_long$component <- factor(stl_long$component,
    levels = c("original", "trend", "seasonal", "remainder"))

  ggplot(stl_long, aes(x = time, y = value)) +
    geom_line(color = "steelblue", alpha = 0.7) +
    facet_wrap(~component, scales = "free_y", ncol = 1) +
    labs(x = "Time", y = "Wave Height (m)",
         title = paste0("STL Decomposition (", date_caption, ")")) +
    theme_minimal()
} else {
  cat("STL decomposition not available")
}
```

# Extreme Values

## Row

### Column {.tabset}

#### Wave Return Levels

```{r}
if (!is.null(return_levels_wave)) {
  plot_ly(return_levels_wave, x = ~return_period, y = ~return_level,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "steelblue"),
    line = list(color = "steelblue"),
    text = ~paste0("Return Period: ", return_period, " years<br>",
                   "Hs: ", round(return_level, 2), " m<br>",
                   "95% CI: [", round(lower, 2), ", ", round(upper, 2), "]"),
    hoverinfo = "text",
    name = "Return Level"
  ) |>
    add_ribbons(ymin = ~lower, ymax = ~upper,
      fillcolor = "rgba(70, 130, 180, 0.2)",
      line = list(color = "transparent"),
      name = "95% CI", showlegend = TRUE
    ) |>
    layout(
      title = paste0("Wave Height Return Levels - GEV (", date_caption, ")"),
      xaxis = list(title = "Return Period (years)", type = "log"),
      yaxis = list(title = "Hs (m)")
    )
} else {
  cat("Return levels not available. Run targets::tar_make()")
}
```

#### Wave Return (Data)

```{r}
if (!is.null(return_levels_wave)) {
  return_levels_wave |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Wave Height Return Levels")
}
```

#### Wind Return Levels

```{r}
if (!is.null(return_levels_wind)) {
  plot_ly(return_levels_wind, x = ~return_period, y = ~return_level,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "darkorange"),
    line = list(color = "darkorange"),
    text = ~paste0("Return Period: ", return_period, " years<br>",
                   "Wind: ", round(return_level, 2), " m/s<br>",
                   "95% CI: [", round(lower, 2), ", ", round(upper, 2), "]"),
    hoverinfo = "text",
    name = "Return Level"
  ) |>
    add_ribbons(ymin = ~lower, ymax = ~upper,
      fillcolor = "rgba(255, 140, 0, 0.2)",
      line = list(color = "transparent"),
      name = "95% CI", showlegend = TRUE
    ) |>
    layout(
      title = paste0("Wind Speed Return Levels - GEV (", date_caption, ")"),
      xaxis = list(title = "Return Period (years)", type = "log"),
      yaxis = list(title = "Wind Speed (m/s)")
    )
}
```

#### Hmax Return Levels

```{r}
if (!is.null(return_levels_hmax)) {
  plot_ly(return_levels_hmax, x = ~return_period, y = ~return_level,
    type = "scatter", mode = "lines+markers",
    marker = list(size = 8, color = "darkred"),
    line = list(color = "darkred"),
    text = ~paste0("Return Period: ", return_period, " years<br>",
                   "Hmax: ", round(return_level, 2), " m<br>",
                   "95% CI: [", round(lower, 2), ", ", round(upper, 2), "]"),
    hoverinfo = "text",
    name = "Return Level"
  ) |>
    add_ribbons(ymin = ~lower, ymax = ~upper,
      fillcolor = "rgba(139, 0, 0, 0.2)",
      line = list(color = "transparent"),
      name = "95% CI", showlegend = TRUE
    ) |>
    layout(
      title = paste0("Max Wave Height Return Levels - GEV (", date_caption, ")"),
      xaxis = list(title = "Return Period (years)", type = "log"),
      yaxis = list(title = "Hmax (m)")
    )
}
```

#### Summary Table

```{r}
if (!is.null(return_levels_wave)) {
  bind_rows(
    if (!is.null(return_levels_wave)) return_levels_wave |> mutate(Variable = "Hs") else NULL,
    if (!is.null(return_levels_hmax)) return_levels_hmax |> mutate(Variable = "Hmax") else NULL,
    if (!is.null(return_levels_wind)) return_levels_wind |> mutate(Variable = "Wind") else NULL
  ) |>
    select(Variable, return_period, return_level, lower, upper) |>
    mutate(across(where(is.numeric), ~round(., 1))) |>
    create_dt("Return Levels Summary")
}
```

# Gust Factor

## Row

### Column {.tabset}

#### Summary by Station

Gust Factor = Peak Gust / Sustained Wind. Typical value: ~1.3

```{r}
if (!is.null(gust_analysis) && "by_station" %in% names(gust_analysis) && !is.null(gust_analysis$by_station)) {
  gust_analysis$by_station |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor Statistics by Station")
} else if (!is.null(gust_analysis) && "summary" %in% names(gust_analysis)) {
  gust_analysis$summary |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor Statistics (all stations)")
} else {
  cat("Gust analysis not available. Run targets::tar_make()")
}
```

#### Overall Summary

```{r}
if (!is.null(gust_analysis) && "summary" %in% names(gust_analysis)) {
  gust_analysis$summary |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor Statistics (All Stations Combined)")
}
```

#### By Wind Category

```{r}
if (!is.null(gust_analysis) && "by_station_category" %in% names(gust_analysis) && !is.null(gust_analysis$by_station_category)) {
  gust_sc <- gust_analysis$by_station_category

  plot_ly(gust_sc, x = ~wind_category, y = ~mean_gf, color = ~station_id,
    type = "bar",
    text = ~paste0("Station: ", station_id, "<br>",
                   "Category: ", wind_category, "<br>",
                   "Mean GF: ", round(mean_gf, 2), "<br>",
                   "P95 GF: ", round(p95_gf, 2), "<br>",
                   "n: ", n),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Gust Factor by Wind Category and Station (", date_caption, ")"),
      xaxis = list(title = "Wind Speed Category (m/s)"),
      yaxis = list(title = "Mean Gust Factor"),
      barmode = "group",
      shapes = list(
        list(type = "line", x0 = -0.5, x1 = 4.5,
             y0 = 1.3, y1 = 1.3, line = list(color = "red", dash = "dash", width = 2))
      ),
      annotations = list(
        list(x = 4, y = 1.3, text = "Typical (1.3)",
             showarrow = FALSE, yanchor = "bottom", font = list(color = "red", size = 10))
      )
    )
} else if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_cat <- gust_analysis$by_category

  plot_ly(gust_cat, x = ~wind_category, y = ~mean_gf,
    type = "bar",
    marker = list(color = "darkorange"),
    text = ~paste0("Category: ", wind_category, "<br>",
                   "Mean GF: ", round(mean_gf, 2), "<br>",
                   "P95 GF: ", round(p95_gf, 2)),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("Gust Factor by Wind Speed Category (", date_caption, ")"),
      xaxis = list(title = "Wind Speed Category (m/s)"),
      yaxis = list(title = "Gust Factor"),
      shapes = list(
        list(type = "line", x0 = -0.5, x1 = nrow(gust_cat) - 0.5,
             y0 = 1.3, y1 = 1.3, line = list(color = "red", dash = "dash", width = 2))
      ),
      annotations = list(
        list(x = nrow(gust_cat) - 1, y = 1.3, text = "Typical (1.3)",
             showarrow = FALSE, yanchor = "bottom", font = list(color = "red", size = 10))
      )
    )
}
```

#### By Wind Category (Data)

```{r}
if (!is.null(gust_analysis) && "by_station_category" %in% names(gust_analysis) && !is.null(gust_analysis$by_station_category)) {
  gust_analysis$by_station_category |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor by Wind Category and Station")
} else if (!is.null(gust_analysis) && "by_category" %in% names(gust_analysis)) {
  gust_analysis$by_category |>
    mutate(across(where(is.numeric), ~round(., 2))) |>
    create_dt("Gust Factor by Wind Category")
}
```

#### Rogue Gusts by Station

```{r}
if (!is.null(gust_analysis) && "by_station" %in% names(gust_analysis) && !is.null(gust_analysis$by_station)) {
  bs <- gust_analysis$by_station

  plot_ly(bs, x = ~station_id, y = ~pct_rogue,
    type = "bar",
    marker = list(color = ~n_rogue,
                  colorscale = list(c(0, "#fee0d2"), c(1, "#de2d26")),
                  showscale = TRUE,
                  colorbar = list(title = "n events")),
    text = ~paste0("Station: ", station_id, "<br>",
                   "Rogue Gusts: ", n_rogue, " (", round(pct_rogue, 3), "%)<br>",
                   "Threshold: GF > ", round(gust_analysis$rogue_gust_threshold, 1), "<br>",
                   "Total obs: ", n, "<br>",
                   "Mean GF: ", round(mean_gf, 2), "<br>",
                   "Max GF: ", round(max_gf, 2)),
    hoverinfo = "text"
  ) |>
    layout(
      title = paste0("'Rogue Gust' Events by Station (GF > ",
                     round(gust_analysis$rogue_gust_threshold, 1), ")"),
      xaxis = list(title = "Station"),
      yaxis = list(title = "% of Observations")
    )
}
```

# Reference

## Row

### Column {width=50%}

#### Extreme Value Analysis Methods

| Method | Description | Use Case |
|--------|-------------|----------|
| **GEV** | [Generalized Extreme Value](https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution) | Annual maxima |
| **GPD** | [Generalized Pareto](https://en.wikipedia.org/wiki/Generalized_Pareto_distribution) | Peaks over threshold |
| **Return Level** | Value expected to be exceeded once per T years | Design specifications |
| **STL** | [Seasonal-Trend Loess](https://en.wikipedia.org/wiki/STL_decomposition) | Trend detection |

### Column {width=50%}

#### Beaufort Wind Scale

| Beaufort | Description | Wind Speed (m/s) |
|----------|-------------|-------------------|
| 0-5 | Calm to Fresh Breeze | 0 - 10.7 |
| 6-7 | Strong Breeze to Near Gale | 10.8 - 17.1 |
| 8-9 | Gale to Severe Gale | 17.2 - 24.4 |
| 10 | Storm | 24.5 - 28.4 |
| 11 | Violent Storm | 28.5 - 32.6 |
| 12 | Hurricane Force | > 32.7 |

**References:**

- Longuet-Higgins, M.S. (1952). Statistical distribution of sea waves. *J. Marine Research*, 11, 245-266.
- Dysthe, K. et al. (2008). Oceanic rogue waves. *Ann. Rev. Fluid Mech.*, 40, 287-310.
- Coles, S. (2001). *Statistical Modeling of Extreme Values*. Springer.

---

*Analysis generated `r generated_time` using irishbuoys v`r pkg_version`*
